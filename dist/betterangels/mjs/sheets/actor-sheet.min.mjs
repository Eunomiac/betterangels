import{C as t,gsap as a,Dragger as e,MotionPathPlugin as s,U as i,MIX as o,UpdateQueue as r}from"../helpers/bundler.mjs";export default class extends(o(ActorSheet).t(r)){static get i(){return mergeObject(super.i,{o:["betterangels","sheet","actor"],l:"systems/betterangels/hbs/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/hbs/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=(a=super.getData(),{...a,type:a.m.data.type,data:a.m.data.data,flags:a.m.data.flags});var a;return["hellbound","minornpc","mobnpc"].includes(t.type)&&(this.g(t),this.v(t)),t}v(t){t.data.S=["greed","cunning","espionage","cruelty","sly","contempt","corruption","devious","deceit"].map((t=>this.k(t)))}g(t){console.log({T:t,D:t.items}),Object.assign(t.data,{P:t.items.filter((t=>"power"===t.type)).slice(t.data.A?-3:-2),_:t.items.filter((t=>"aspect"===t.type)).slice(-2),C:t.items.filter((t=>"device"===t.type)).slice(-2)})}I(s){if(super.I(s),window.O=s,window.sheet=this,s.find(".trait-name").R(((t,e)=>{const s=$(e).find(".trait-label"),o=$(`<div class="trait-dragger" \n\t\t\t\t\t\t\tdata-trait="${e.dataset.M}"\n\t\t\t\t\t\t\tdata-value="${e.dataset.value}"\n\t\t\t\t\t\t\tdata-type="${e.dataset.type}"\n\t\t\t\t\t\t\tdata-sub-type="${e.dataset.N}"\n\t\t\t\t>`).appendTo(e),r=$('<div class="trait-big-display"></div>').appendTo(o);a.set([s,o,r],{position:"absolute",display:"block",j:-50,F:-50,height:a.G(e,"height"),width:a.G(e,"width"),x:.5*i.get(e,"width"),y:.5*i.get(e,"height"),transformOrigin:"50% 50%"}),a.set(r,{height:5*a.G(e,"height"),width:2*a.G(e,"width"),pointerEvents:"none"}),a.set(o,{width:.8*a.G(e,"width"),x:`${"sinister"===o.data("subType")?"-":"+"}=${.1*a.G(e,"width")}`,pointerEvents:"all"});const n={x:a.G(s[0],"x"),y:a.G(s[0],"y")},l=i.K(s,r);console.log({L:n,H:l,label:s[0],display:r[0]})})),!this.B)return;const o=this;s.find(".radial-hover").contextmenu(this.X.bind(this)),s.find(".radial-hover").q(this.J.bind(this)),s.find(".trait-button").click(this.U.bind(this)),s.find(".trait-button").contextmenu(this.U.bind(this)),s.find(".feature").V({pointerEvents:"all"}).click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.W(!0)})),s.find(".trait-pair.strategy label.sinister .draggable").Y(this.Z.bind(this)),s.find(".trait-pair .virtuous").R(((t,a)=>{$(a).find(".trait.draggable").R(((t,e)=>i.set([e,$(e).prev()],{x:i.get(a,"width")-1.1*i.get(e,"width")})))})),e.create(`#actor-${this.m.id} .draggable.trait`,{tt(){this.M=this.target.dataset.target,[this.type,this.et]=t.st.includes(this.M)?["strategy","tactic"]:["tactic","strategy"],console.log({it:this.M,ot:this.type,rt:this.et,nt:t.st.includes(this.M)}),this.lt=Array.from(s.find(`#trait-label-${this.M} .display.trait, .draggable.trait.${this.et}`)),[this.ct]=s.find(this.target).parent(),s.find(".trait-pair label.droppable").ht("no-hover"),i.dt(this.target,$("#x-container")[0]),this.update(!1,!0),console.log({ut:this}),a.to(this.target,{scale:2,fontFamily:"KomikaAxis, sans-serif",color:t.O.$t[this.type],opacity:1,duration:2,textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",yt:"elastic.out"})},bt:{points(e){if(!this.lt||0===this.lt.length)return e;let s,i=50;for(;i<80&&(!s||s.length>1);){const t=(s??[...this.lt]).filter((t=>this.gt(t,`${i}%`)));if(0===t.length)break;s=[...t],i+=10}return s&&s.includes(this.vt)?e:(this.ft?.reverse(),s?([this.vt]=s,this.ft=a.to(this.vt,{xt(){a.set(this.vt,{zIndex:1e3})},scale:2,fontFamily:"KomikaAxis, sans-serif",color:t.O.$t[$(this.vt).hasClass("display")?this.type:this.et],opacity:1,yt:"back",textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",duration:.5}),e):(this.vt=null,e))}},wt(){console.log("DRAG END"),console.log(`SNAP TARGET: ${this.vt?.dataset?.target}`);const[e,r]=[this.target.dataset.target,this.target.dataset.value],[n,l]=[this.vt?.dataset?.target,this.vt?.dataset?.value];this.disable(),i.dt(this.target,this.ct),a.to(this.target,{scale:1,opacity:0,duration:.25,yt:"elastic.out",St:this,kt(){a.set(`#actor-${o.m.id} .draggable`,{x:0,y:0}),this.enable(),s.find("label.droppable").Tt("no-hover"),o.Dt(e,r,n,l)}}),a.to(this.vt,{y:0,color:t.O.$t.Pt,textShadow:"none",fontSize:14,scale:1,yt:"power4.out",duration:.25})}})}k(a){const[e,s]=[a,t.At[a]],{data:o}=this._t,[r,n]=[o[e],o[s]];return[{name:e,displayName:i.Ct(e),type:t.st.includes(e)?"strategy":"tactic",N:"sinister",...r,It:r.value<r.max&&n.value>n.min,Ot:r.value<r.max&&r.value+n.value<7,Et:r.value>r.min,Rt:r.max-r.value,isPrimary:e===o.Mt},{name:s,displayName:i.Ct(s),type:t.st.includes(s)?"strategy":"tactic",N:"virtuous",...n,It:n.value<n.max&&r.value>r.min,Ot:n.value<n.max&&n.value+r.value<7,Et:n.value>n.min,Rt:n.max-n.value,isPrimary:s===o.Mt}]}Nt(a){a=t.jt[a]??a;const[e,s]=this.k(a);i.Ft({[`#menu-add-drop-${e.name}`]:{Gt:e.Ot,Kt:e.Et},[`#menu-add-drop-${s.name}`]:{Gt:s.Lt,Kt:s.Et},[`#menu-slide-${e.name}`]:{zt:e.It},[`#menu-slide-${s.name}`]:{Ht:s.It}},((t,a)=>i.Ft(t,((t,e)=>{t?$(`#${this.m.id} ${a}`).ht(e):$(`#${this.m.id} ${a}`).Tt(e)}))))}X(t){t.preventDefault(),console.log("Open Menu",t);const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find(".radial-menu").hasClass("active")||(a.set(e,{j:-50,F:-50,x:t.offsetX,y:t.offsetY}),$(e).find("video").R((function(){this.play()})),$(e).find(".radial-menu").ht("active"))}J(t){t.preventDefault();const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find("video").R((function(){this.pause()})),$(a).find(".radial-menu").Tt("active"),setTimeout((()=>this.Bt()),500)}async U(a){a.preventDefault(),console.log({Xt:a});const{qt:e,Jt:s,target:i}=a.target.dataset,{data:o}=this._t,r={click:e,contextmenu:s}[a.type];if(this.k(i)[0][r]){switch(r){case"add":{const t=Math.min(o[i].max,o[i].value+1);this.Qt({[`data.${i}.value`]:t}),this.Ut(i,t);break}case"drop":this.Vt(i,o[i].value),this.Qt({[`data.${i}.value`]:Math.max(o[i].min,o[i].value-1)});break;case"slide":{const a=t.At[i],e=Math.min(o[i].max,o[i].value+1);this.Wt(i,e,a,o[a].value),this.Qt({[`data.${i}.value`]:e,[`data.${a}.value`]:Math.max(o[a].min,o[a].value-1)});break}default:return!1}return this.Nt(i),!0}return!1}Ut(t,e){const[s]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`);a.timeline({xt(){$(s).ht("full top-layer")},Zt(){$(s).ht("full"),$(s).Tt("top-layer"),a.set(s,{ta:"all"})},kt(){$(s).ht("full"),$(s).Tt("top-layer"),a.set(s,{ta:"all"})}}).Yt(s,{scale:10,opacity:0},{scale:1,opacity:1,yt:"sine",duration:.75,ta:!0})}Vt(t,e){const[s]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`);a.timeline({xt(){$(s).ht("top-layer")},Zt(){$(s).Tt("full top-layer"),a.set(s,{ta:"all"})},kt(){$(s).Tt("full top-layer"),a.set(s,{ta:"all"})}}).Yt(s,{scale:1,opacity:1},{scale:10,opacity:0,yt:"sine",duration:.75,ta:!0})}Wt(t,e,s,o){const[r]=$(`#actor-${this.m.id} #${s}-${o} > .dot-slot`),[n]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`#actor-${this.m.id} #${s}-${o}`);a.to(l,{...i.aa({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,yt:"slow(0.7, 0.7)",xt(){$(r).Tt("full")},Zt(){$(n).ht("full"),$(l).remove()},kt(){$(n).ht("full"),$(l).remove()}}),a.to(l,{scale:5,duration:.5,yt:"slow(0.7, 0.7, true)"})}async Z(t){const a=t.currentTarget.dataset.target;await this.m.update({ea:a})}async Dt(a,e,s,o,r={}){a===s&&(s=!1);const n=[],l=[];for(const[r,l]of[[a,e],[s,o]])if(r){const a=['<span class="character">(</span>',`<span class="trait-value">${l}</span>`,'<span class="character">)</span>'];t.st.includes(r)?(a.unshift(`<span class="trait-name strategy">${i.Ct(r)}</span>`),n.unshift(a.join(""))):t.sa.includes(r)?(a.unshift(`<span class="trait-name tactic">${i.Ct(r)}</span>`),n.push(a.join(""))):(a.unshift(`<span class="trait-name">${i.Ct(r)}</span>`),n.push(a.join("")))}let c=0,p=0;for(const[t,{ia:a,width:e}]of Object.entries(r)){const s=`<span class="advantage-glyph">${{oa:"‚öîÔ∏è",ra:'<span style="color: #FF0000; font-weight: bold; text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black;">!!</span>',na:"üîç"}[t]}</span>`;a&&(c+=a,n.push(`<span class="trait-value">${a}</span>${s}`)),e&&(p+=e,l.push(`<span class="trait-value">+${e}</span>${s}`))}const h=i.la(e)+i.la(o)+i.la(c),d=[n.join('<span class="operator">+</span>'),'<span class="operator">=</span>',`<span class="pool-total">${h}</span>`].join(""),u=game.oneRollEngine.createRawRoll(h),{ca:$,pa:y,ha:m}=game.oneRollEngine.parseRawRoll(u,d),b=$.sort(((t,a)=>t.width>a.width?-10:a.width>t.width?10:a.height-t.height));0===$.length&&(l.length=0),console.log({ca:$,pa:y,da:m,ua:l,$a:r});const g={content:await renderTemplate("systems/betterangels/hbs/chat/ORE-roll.html",{name:this.m.name,ca:b,pa:y,da:m,ua:l.join(", ")}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,ya:u,flags:{ma:{ba:!0}}};return ChatMessage.create(g,{})}}export const HOOKS={ga:(t,e)=>{const{type:s}=e,{m:i}=t,{items:o}=i,r=Array.from(o.values()).filter((t=>t.type===e.type)).map((t=>t.id)),n={va:i.data.data.A?3:2,fa:2,device:3}[s],l=[];for(;r.length>=n;)l.push(r.shift());console.log({type:s,m:i,items:o,xa:r,wa:n,Sa:l}),l.length&&(i.ka("Item",l),a.Ta(.25,(()=>i.sheet.W())))}};