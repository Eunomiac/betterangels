import{C as t,gsap as e,Dragger as a,MotionPathPlugin as s,SplitText as i,U as r,MIX as o,UpdateQueue as n}from"../helpers/bundler.mjs";export default class extends(o(ActorSheet).t(n)){static get i(){return mergeObject(super.i,{o:["betterangels","sheet","actor"],l:"systems/betterangels/hbs/actor/actor-sheet.html",width:476,height:786,h:[{p:".sheet-tabs",u:".sheet-body",g:"front"}]})}get l(){return`systems/betterangels/hbs/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t={...super.getData()};return this.$(t),this.v(t),this.T(t),t}$(t){Object.assign(t,{...t,type:t.m.data.type,data:t.m.data.data,flags:t.m.data.flags})}T(e){e.data.D=t.A.map((t=>this.C(t)))}v(t){Object.assign(t.data,{S:t.items.filter((t=>"power"===t.type)).slice(t.data.P?-3:-2),k:t.items.filter((t=>"aspect"===t.type)).slice(-2),_:t.items.filter((t=>"device"===t.type)).slice(-2)})}get M(){return $(`#actor-${this.m.id}`)}get O(){return Boolean(this.M.find(".is-dragging")[0])}R(t){super.R(t);const s=this.M.find('.trait-label[data-trait="cunning"]');if(s.find(".roll-desc")[0].innerText="CUNNING + Espionage + 3✒️ + 2⚔️ = 10",s.find(".to-width-advantages .to-width-label")[0].innerText="To Width:",s.find(".to-width-advantages .general")[0].innerText="💡",s.find(".to-width-advantages .weapon")[0].innerText="⚔️",s.find(".to-width-advantages .surprise")[0].innerText="",s.find(".to-width-advantages .secret")[0].innerText="",t.find(".trait-label").I(this.N.bind(this)),t.find(".trait-label").F(this.H.bind(this)),!this.j)return;t.find(".trait-cell").contextmenu(this.L.bind(this)),t.find(".trait-cell").F(this.B.bind(this)),t.find(".trait-button").click(this.G.bind(this)),t.find(".trait-button").contextmenu(this.G.bind(this)),t.find('.trait-label[data-type="strategy"][data-sub-type="sinister"]').K(this.U.bind(this)),t.find(".hover-target video").W("ended",(({currentTarget:t})=>{t.currentTime=0})),t.find(".feature").click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.q(!0)})),a.create(this.M.find(".trait-label"),{J:[this],V(t){$(this.target).X("is-dragging"),this.Y=$(this.target).data("trait"),this.type=$(this.target).data("type"),this.Z="strategy"===this.type?"tactic":"strategy",[this.tt]=t.M.find(".trait-label.is-dragging + .trait-label-bg"),[this.et,this.st]=r.it(Array.from(t.M.find(".trait-draggable:not(.is-dragging)")),(t=>$(t).data("type")!==this.type)),[this.rt,this.ot]=r.it(Array.from(t.M.find(".roll-over-mod")),(t=>$(t).data("action"))),this.nt=[...this.rt,...this.ot],this.lt=[...this.et,this.tt],this.ct=[...this.lt,...this.nt],console.log({tt:this.tt,et:this.et,lt:this.lt,ct:this.ct}),t.ht(this.target,"dragging",{duration:.5,dt:"elastic"}),t.ht(this.et,"bright",{duration:1,dt:"sine",ut:1}),t.ht(this.st,"faded",{duration:1,dt:"sine",ut:1})},gt:[this],$t(t){const e=t.bt(this);e!==this.ft&&(t.yt(e,this.ft),this.ft=e);const a=t.vt(this);a!==this.Tt&&(t.Dt(a,this.Tt),this.Tt=a)},wt:[this],xt(t){this.disable(),this.ft?(this.lt=this.lt.filter((t=>t!==this.ft)),console.log(`Dropped on ${this.ft.dataset?.Y?.toUpperCase()}`)):console.log("Dropped on NO TARGET"),t.ht([...this.lt,...this.st],"base",{duration:.5,dt:"sine",ut:5}),t.ht(this.ft,"base",{duration:5}),t.ht(this.target,"hoverOver",{duration:1.5,dt:"power2"}).then((()=>{t.ht(this.target,"base",{duration:0}),e.set(this.target,{x:0,y:0}),$(this.target).At("is-dragging"),this.enable()}))}})}q(...t){delete this.Ct,delete this.St,super.q(...t)}get Pt(){return this.kt||(this.kt=new Map,this.M.find(".trait-draggable")._t(((t,e)=>{this.kt.set(e,this.Mt(e))})),this.M.find(".hover-target")._t(((t,e)=>{this.kt.set(e,this.Ot(e))}))),this.kt}Et(t){return this.Pt.get(r.Rt(t))}It(t){return r.Nt(t).map((t=>this.Pt.get(t)))}Mt(a){$(a).data("trait");const s=$(a).data("type");return e.timeline({paused:!0,Lt:{dt:"none"}}).Ht("faded",0).jt(a,{zt:.25,color:t.Kt.Gt.Bt,scale:1,textShadow:t.Kt.Wt.Ut},{zt:1}).Ht("base").to(a,{color:t.Kt.Gt.qt,scale:1.15}).Ht("bright").to(a,{color:t.Kt.Gt[`${s}Dark`],scale:1.25,textShadow:t.Kt.Wt[`${s}Hover`]}).Ht("hoverOver").to(a,{color:t.Kt.Gt.Jt,scale:1.5,textShadow:t.Kt.Wt.ft}).Ht("dropTarget").to(a,{color:t.Kt.Gt[s],scale:2}).Ht("dragging").Ft("base")}Ot(a){const s=$(a),i=s.data("action"),r=s.data("type"),[o]=s.find(".target-icon"),[n]=s.find(".target-label"),[l]=s.find("video"),[c]=s.find(".target-trigger-anim");return e.timeline({paused:!0,Lt:{dt:"none"}}).to([a,o,n,l,c],{zt:0,scale:0,duration:0,textShadow:0,outline:0}).Ht("hidden").to([a,o,l],{zt:.75,scale:.8,ut:.25},">").to(n,{zt:1,scale:1,delay:.5,textShadow:t.Kt.Wt[`${i}HoverTrigger`]},"<").Ht("visible").to([a,o,l],{zt:1,scale:1}).to(n,{Qt:{scale:[1,1.25,1,1,1,1],outline:[0,0,`3px solid ${t.Kt.Gt[`${i}HoverTrigger`]}`]}},"<").Ht("startCycle").call((()=>{l.currentTime=0,l.play()})).to(o,{Qt:{scale:[1,1.25,1,.75,1],dt:"sine.inOut"},duration:l.duration},"<").to(c,{zt:.75,scale:1,dt:"power2.in",duration:l.duration},"<").call((()=>{this.Vt(i,r)})).to(l,{zt:0,duration:.25}).to(c,{Qt:{zt:[.75,1,0,0,0],scale:[1,10],dt:"power4.out"},duration:.25},"<").to(c,{scale:1,duration:0,Xt:[this],Yt(t){t.ht(a,"endCycle",{from:"startCycle",Zt:20})}}).Ht("endCycle").Ft("hidden")}ht(t,a,{from:s,te:i=0,Zt:r=.5,duration:o,dt:n,ut:l=0,ee:c="random"}={}){const h=this.It(t).map((e=>{if(e){const h=s?e.ae(s,a,n?{dt:n,paused:!0}:{paused:!0}):e.se(a,n?{dt:n,paused:!0}:{paused:!0}),d=h.duration(),p=o??Math.max(Math.min(d,r),i),u={[`${t}`]:a,ie:{te:i,Zt:r,duration:o,dt:n,ut:l,ee:c},duration:{re:d,oe:p}};return parseFloat(p)!==parseFloat(d)&&h.ne(d/p),u.duration.le=h.duration(),h}return!1})).filter((t=>Boolean(t)));if(0===h.length)return[];if(1===h.length)return h[0].delay(0).play();if(l>0){const t=e.he.ce({de:l,from:c});return h.map(((e,a,s)=>e.delay(t(a,s[a],s)).play()))}return h.map((t=>t.delay(0).play()))}N({currentTarget:t}){this.O||this.ht(t,"hoverOver",{from:"bright",duration:.25,dt:"power2.out"})}H({currentTarget:t}){this.O||this.ht(t,"base",{duration:.25,dt:"power2.in"})}bt(t){const e=e=>a=>t.pe(a,`${e}%`);let a,[s]=r.it(t.lt,e(50));for(let t=40;t>=0&&!(s.length<=1);t-=10)[s,a]=r.it(s,e(t));return[...s,...a??[]].shift()}yt(t,e){[t,e]=r.Nt(t,e),e&&!$(e).hasClass("trait-label-bg")&&this.ht(e,"bright"),t&&!$(t).hasClass("trait-label-bg")&&this.ht(t,"dropTarget",{duration:.25})}vt(t){const e=e=>a=>t.pe(a,`${e}%`);let a,[s]=r.it(t.nt,e(50));for(let t=40;t>=0&&!(s.length<=1);t-=10)[s,a]=r.it(s,e(t));return[...s,...a??[]].shift()}Dt(t,e){[t,e]=r.Nt(t,e),e&&this.ht(e,"visible"),t&&this.ht(t,"startCycle",{Zt:.25}).then((()=>this.ht(t,"endCycle",{Zt:20})))}C(e){const[a,s]=[e,t.ue[e]],{data:i}=this.ge,[o,n]=[i[a],i[s]],l=[{name:a,displayName:r.me(a),type:t.$e.includes(a)?"strategy":"tactic",be:"sinister",...o,fe:o.value<o.max&&n.value>n.min,ye:o.value<o.max&&o.value+n.value<7,ve:o.value>o.min,Te:o.max-o.value,isPrimary:a===i.De,we:t.Ce[t.$e.includes(a)?"xe":"Ae"]},{name:s,displayName:r.me(s),type:t.$e.includes(s)?"strategy":"tactic",be:"virtuous",...n,fe:n.value<n.max&&o.value>o.min,ye:n.value<n.max&&n.value+o.value<7,ve:n.value>n.min,Te:n.max-n.value,isPrimary:s===i.De,we:t.Ce[t.$e.includes(a)?"xe":"Ae"]}];return t.Se.includes(e)&&l.reverse(),l}Pe(e){e=t.ke[e]??e;const[a,s]=this.C(e);r._e({Me:{Oe:a.ye,Ee:a.ve},Re:{Oe:s.Ie,Ee:s.ve},Ne:{Fe:a.fe},He:{je:s.fe}},((t,e)=>r._e(t,((t,a)=>{const s=$(`#actor-${this.m.id} .radial-menu .menu-container .menu-button ${e}`);t?s.X(a):s.At(a)}))))}L(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{Le:-50,ze:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video")._t((function(){this.play()})),$(a).find(".radial-menu").X("active"))}B(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video")._t((function(){this.pause()})),$(e).find(".radial-menu").At("active"),setTimeout((()=>this.Be()),500)}async G(e){e.preventDefault();const{Ge:a,Ke:s,target:i}=e.target.dataset,{data:r}=this.ge,[o]=this.C(i),n={click:a,contextmenu:s}[e.type];switch(console.log({Ue:e,Ge:a,Ke:s,target:i,data:r,action:n,We:o}),n){case"add":if(o.ye){const t=Math.min(o.max,o.max+1);this.qe({[`data.${i}.value`]:t}),this.Je(i,t)}break;case"drop":o.ve&&(this.Qe(i,r[i].value),this.qe({[`data.${i}.value`]:Math.max(r[i].min,r[i].value-1)}));break;case"slide":if(o.fe){const e=t.ue[i],a=Math.min(r[i].max,r[i].value+1);this.Ve(i,a,e,r[e].value),this.qe({[`data.${i}.value`]:a,[`data.${e}.value`]:Math.max(r[e].min,r[e].value-1)})}break;default:return!1}return this.Pe(i),!0}Xe(t,a){const s=$(`#actor-${this.m.id} .dot-line > #${t}-${a}`),i=s.Ye(".trait-cell"),o=s.clone().ta({background:"cyan"}).Ze(i),n=r.ea(s,i);return e.set(r.Rt(o),{position:"absolute",Le:-50,ze:-50,height:r.get(s,"height"),width:r.get(s,"width"),x:n.x,y:n.y,zIndex:100}),o.data("addDropTimeline",e.timeline({Yt(){s.X("full"),o.remove()},aa(){s.At("full"),o.remove()},paused:!0}).from(o,{scale:10,zt:0,dt:"sine",duration:.75},0)),o}Je(e,a){console.log(`Filling ${e}-${a}`);const s=$(`#actor-${this.m.id} .dot-line.${t.A.includes(e)?"sinister":"virtuous"} #${e}-${a}`),i=s.Ye(".trait-cell");let r=$(`#actor-${this.m.id} .trait-cell > #${e}-${a}`);console.log({sa:s[0],ia:i[0],ra:r[0]}),console.log({sa:s[0]?.id,ia:i[0]?.id,ra:r[0]?.id}),r?r.data("addDropTimeline")?r.data("addDropTimeline").play():r.data("slideTimeline")&&r.data("slideTimeline").reverse().then((()=>this.Je(e,a))):(r=this.Xe(e,a),r.data("addDropTimeline").play())}Qe(t,e){const a=$(`#actor-${this.m.id} .dot-line > #${t}-${e}`),s=a.Ye(".trait-cell");let i=$(`#actor-${this.m.id} .trait-cell > #${t}-${e}`);console.log({oa:a,na:s,la:i}),i?i.data("addDropTimeline")?(a.At("full"),i.data("addDropTimeline").reverse()):i.data("slideTimeline")&&i.data("slideTimeline").reverse().then((()=>this.Qe(t,e))):(i=this.Xe(t,e),a.At("full"),i.data("timeline").reverse(0))}Ve(t,a,s,i){const[o]=$(`#actor-${this.m.id} #${s}-${i} > .dot-slot`),[n]=$(`#actor-${this.m.id} #${t}-${a} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').Ze(`#actor-${this.m.id} #${s}-${i}`);e.to(l,{...r.ca({x:0,y:0},$(n).parent()[0],$(o).parent()[0]),duration:.5,dt:"slow(0.7, 0.7)",ha(){$(o).At("full")},da(){$(n).X("full"),$(l).remove()},Yt(){$(n).X("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,dt:"slow(0.7, 0.7, true)"})}async U(t){const e=t.currentTarget.dataset.Y;await this.m.update({pa:e})}async ua(e,a,s,i,o={}){e===s&&(s=!1);const n=[],l=[];for(const[o,l]of[[e,a],[s,i]])if(o){const e=['<span class="character">(</span>',`<span class="trait-value">${l}</span>`,'<span class="character">)</span>'];t.$e.includes(o)?(e.unshift(`<span class="trait-name strategy">${r.me(o)}</span>`),n.unshift(e.join(""))):t.ga.includes(o)?(e.unshift(`<span class="trait-name tactic">${r.me(o)}</span>`),n.push(e.join(""))):(e.unshift(`<span class="trait-name">${r.me(o)}</span>`),n.push(e.join("")))}let c=0,h=0;for(const[t,{ma:e,width:a}]of Object.entries(o)){const s=`<span class="advantage-glyph">${{$a:"⚔️",ba:'<span style="color: #FF0000; font-weight: bold; text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black;">!!</span>',fa:"🔍"}[t]}</span>`;e&&(c+=e,n.push(`<span class="trait-value">${e}</span>${s}`)),a&&(h+=a,l.push(`<span class="trait-value">+${a}</span>${s}`))}const d=r.ya(a)+r.ya(i)+r.ya(c),p=[n.join('<span class="operator">+</span>'),'<span class="operator">=</span>',`<span class="pool-total">${d}</span>`].join(""),u=game.oneRollEngine.createRawRoll(d),{va:g,Ta:m,Da:$}=game.oneRollEngine.parseRawRoll(u,p),b=g.sort(((t,e)=>t.width>e.width?-10:e.width>t.width?10:e.height-t.height));0===g.length&&(l.length=0),console.log({va:g,Ta:m,wa:$,xa:l,Aa:o});const f={content:await renderTemplate("systems/betterangels/hbs/chat/ORE-roll.html",{name:this.m.name,va:b,Ta:m,wa:$,xa:l.join(", ")}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,Ca:u,flags:{Sa:{Pa:!0}}};return ChatMessage.create(f,{})}}export const HOOKS={ka:(t,a)=>{const{type:s}=a,{m:i}=t,{items:r}=i,o=Array.from(r.values()).filter((t=>t.type===a.type)).map((t=>t.id)),n={_a:i.data.data.P?3:2,Ma:2,device:3}[s],l=[];for(;o.length>=n;)l.push(o.shift());console.log({type:s,m:i,items:r,Oa:o,Ea:n,Ra:l}),l.length&&(i.Ia("Item",l),e.Na(.25,(()=>i.sheet.q())))}};export const EFFECTS=[{name:"fade",effect:(t,a)=>e.to(t,{zt:1,duration:a.duration,aa(){e.set(this.Fa,{Ha:"transform"})}}),Lt:{duration:.25},ja:!0},{name:"brighten",effect:(a,s)=>e.to(a,{color:t.Kt.Gt.qt,scale:1.25,duration:s.duration,aa(){e.set(this.Fa,{Ha:"transform"})}}),Lt:{duration:.25},ja:!0},{name:"darken",effect:(t,a)=>e.to(t,{opacity:.25,duration:a.duration,aa(){e.set(this.Fa,{Ha:"transform"})}}),Lt:{duration:.25},ja:!0}];