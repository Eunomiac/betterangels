import{C as t,gsap as e,Dragger as s,MotionPathPlugin as a,SplitText as i,U as o,MIX as r,UpdateQueue as n}from"../helpers/bundler.mjs";export default class extends(r(ActorSheet).t(n)){static get i(){return mergeObject(super.i,{o:["betterangels","sheet","actor"],l:"systems/betterangels/hbs/actor/actor-sheet.html",width:476,height:786,h:[{p:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/hbs/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t={...super.getData()};return this.g(t),this.T(t),this.v(t),t}g(t){Object.assign(t,{...t,type:t.m.data.type,data:t.m.data.data,flags:t.m.data.flags})}v(e){e.data.D=t.S.map((t=>this._(t)))}T(t){Object.assign(t.data,{P:t.items.filter((t=>"power"===t.type)).slice(t.data.R?-3:-2),k:t.items.filter((t=>"aspect"===t.type)).slice(-2),A:t.items.filter((t=>"device"===t.type)).slice(-2)})}get C(){return $(`#actor-${this.m.id}`)}O(a){if(super.O(a),a.find(".trait-label").I(this.M.bind(this)),a.find(".trait-label").N(this.j.bind(this)),!this.F)return;const i=this;a.find(".trait-cell").contextmenu(this.G.bind(this)),a.find(".trait-cell").N(this.H.bind(this)),a.find(".trait-button").click(this.B.bind(this)),a.find(".trait-button").contextmenu(this.B.bind(this)),a.find('.trait-label[data-type="strategy"][data-sub-type="sinister"]').L(this.K.bind(this)),a.find(".feature").click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.q(!0)})),s.create(this.C.find(".trait-label"),{J(){$(this.target).U("is-dragging"),this.V=$(this.target).data("trait"),this.type=$(this.target).data("type"),[this.W]=i.C.find(".trait-label.is-dragging + .trait-label-bg"),[this.X,this.Y]=o.Z(Array.from(i.C.find(".trait-draggable:not(.is-dragging)")),(t=>$(t).data("type")!==this.type)),this.tt=Array.from(i.C.find(".trait-roll-modifier")),this.et=[...this.X,this.W],console.log({st:this.target,V:this.V,type:this.type,W:this.W,X:this.X,Y:this.Y,tt:this.tt,et:this.et}),i.ot[this.V]?.it(.01)?.reverse(),this.rt=e.timeline({lt:this,ct(){e.set(this.target,{ht:"transform,color,textShadow"}),e.to(this.target,{opacity:1,duration:.25}),$(this.target).dt("is-dragging"),this.enable()}}).nt(this.target,{opacity:0},{color:t.$t.ut[this.type],opacity:1,textShadow:[...[2,4,8].map((t=>`0 0 ${1.5*t}px white`)),...[4,7,8,10,15].map((e=>`0 0 ${1.5*e}px ${t.$t.ut[`${this.type}Bright`]}`))].join(", "),scale:2,duration:.25}),this.gt=e.timeline().yt(this.W,0).ft(this.X,0).bt(this.Y,0)},Tt(){this.disable();let t,e=.5;const s={};for(;e>=0;){const a=(t??this.et).filter((t=>this.vt(t,100*e+"%")));if(0===a.length)break;if(t=[...a],s[`${100*e}% (${t.length})`]=[...t],1===t.length)break;e-=.1}const[a]=t??[];console.log({xt:s,Dt:a}),a?console.log(`Dropped on ${a.dataset?.V?.toUpperCase()}`):console.log("Dropped on NO TARGET"),this.rt?.reverse(),this.gt?.reverse()}})}q(...t){delete this.wt,delete this.St,super.q(...t)}get ot(){return this.wt=this.wt??{}}get _t(){return this.Pt=this.Pt??{}}get Rt(){return Boolean(this.C.find(".is-dragging")[0])}M({currentTarget:s}){const a=$(s).data("trait");if(this.Rt){if(!(a in this._t)){t.kt.includes(a);this._t[a]=e.timeline({paused:!0}).to(s,{scale:1.5,textShadow:[...[2,4].map((t=>`0 0 ${1.5*t}px white`)),...[4,7,8,10].map((t=>`0 0 ${1.5*t}px gold`))].join(", "),color:"gold",duration:.15,At:"sine.out"},0)}this._t[a].play()}else{if(!(a in this.ot)){const i=t.kt.includes(a);this.ot[a]=e.timeline({paused:!0}).to(s,{scale:1.25,textShadow:[...[2,4].map((t=>`0 0 ${1.5*t}px white`)),...[4,7,8,10].map((e=>`0 0 ${1.5*e}px ${t.$t.ut[i?"Ct":"Ot"]}`))].join(", "),color:t.$t.ut[i?"It":"Mt"],duration:.15,At:"sine.out"},0)}this.ot[a].play()}}j({currentTarget:t}){const e=$(t).data("trait");this.Rt&&this._t[e]?.reverse(),this.ot[e]?.reverse()}_(e){const[s,a]=[e,t.Et[e]],{data:i}=this.Nt,[r,n]=[i[s],i[a]],l=[{name:s,displayName:o.jt(s),type:t.kt.includes(s)?"strategy":"tactic",Ft:"sinister",...r,Gt:r.value<r.max&&n.value>n.min,Ht:r.value<r.max&&r.value+n.value<7,zt:r.value>r.min,Bt:r.max-r.value,isPrimary:s===i.Lt,Kt:t.Qt[t.kt.includes(s)?"qt":"Jt"]},{name:a,displayName:o.jt(a),type:t.kt.includes(a)?"strategy":"tactic",Ft:"virtuous",...n,Gt:n.value<n.max&&r.value>r.min,Ht:n.value<n.max&&n.value+r.value<7,zt:n.value>n.min,Bt:n.max-n.value,isPrimary:a===i.Lt,Kt:t.Qt[t.kt.includes(s)?"qt":"Jt"]}];return t.Ut.includes(e)&&l.reverse(),l}Vt(e){e=t.Wt[e]??e;const[s,a]=this._(e);o.Xt({Yt:{Zt:s.Ht,te:s.zt},ee:{Zt:a.se,te:a.zt},ae:{ie:s.Gt},oe:{re:a.Gt}},((t,e)=>o.Xt(t,((t,s)=>{const a=$(`#actor-${this.m.id} .radial-menu .menu-container .menu-button ${e}`);t?a.U(s):a.dt(s)}))))}G(t){t.preventDefault(),console.log("Open Menu",t);const[s]=$(t.currentTarget).find(".menu-positioner");$(s).find(".radial-menu").hasClass("active")||(e.set(s,{ne:-50,le:-50,x:t.offsetX,y:t.offsetY}),$(s).find("video").each((function(){this.play()})),$(s).find(".radial-menu").U("active"))}H(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").dt("active"),setTimeout((()=>this.ce()),500)}async B(e){e.preventDefault();const{he:s,de:a,target:i}=e.target.dataset,{data:o}=this.Nt,[r]=this._(i),n={click:s,contextmenu:a}[e.type];switch(console.log({pe:e,he:s,de:a,target:i,data:o,action:n,ue:r}),n){case"add":if(r.Ht){const t=Math.min(r.max,r.max+1);this.$e({[`data.${i}.value`]:t}),this.me(i,t)}break;case"drop":r.zt&&(this.ge(i,o[i].value),this.$e({[`data.${i}.value`]:Math.max(o[i].min,o[i].value-1)}));break;case"slide":if(r.Gt){const e=t.Et[i],s=Math.min(o[i].max,o[i].value+1);this.be(i,s,e,o[e].value),this.$e({[`data.${i}.value`]:s,[`data.${e}.value`]:Math.max(o[e].min,o[e].value-1)})}break;default:return!1}return this.Vt(i),!0}fe(t,s){const a=$(`#actor-${this.m.id} .dot-line > #${t}-${s}`),i=a.ye(".trait-cell"),r=a.clone().ve({background:"cyan"}).Te(i),n=o.xe(a,i);return e.set(o.De(r),{position:"absolute",ne:-50,le:-50,height:o.get(a,"height"),width:o.get(a,"width"),x:n.x,y:n.y,zIndex:100}),r.data("addDropTimeline",e.timeline({we(){a.U("full"),r.remove()},ct(){a.dt("full"),r.remove()},paused:!0}).from(r,{scale:10,Se:0,At:"sine",duration:.75},0)),r}me(e,s){console.log(`Filling ${e}-${s}`);const a=$(`#actor-${this.m.id} .dot-line.${t.S.includes(e)?"sinister":"virtuous"} #${e}-${s}`),i=a.ye(".trait-cell");let o=$(`#actor-${this.m.id} .trait-cell > #${e}-${s}`);console.log({_e:a[0],Pe:i[0],Re:o[0]}),console.log({_e:a[0]?.id,Pe:i[0]?.id,Re:o[0]?.id}),o?o.data("addDropTimeline")?o.data("addDropTimeline").play():o.data("slideTimeline")&&o.data("slideTimeline").reverse().then((()=>this.me(e,s))):(o=this.fe(e,s),o.data("addDropTimeline").play())}ge(t,e){const s=$(`#actor-${this.m.id} .dot-line > #${t}-${e}`),a=s.ye(".trait-cell");let i=$(`#actor-${this.m.id} .trait-cell > #${t}-${e}`);console.log({ke:s,Ae:a,Ce:i}),i?i.data("addDropTimeline")?(s.dt("full"),i.data("addDropTimeline").reverse()):i.data("slideTimeline")&&i.data("slideTimeline").reverse().then((()=>this.ge(t,e))):(i=this.fe(t,e),s.dt("full"),i.data("timeline").reverse(0))}be(t,s,a,i){const[r]=$(`#actor-${this.m.id} #${a}-${i} > .dot-slot`),[n]=$(`#actor-${this.m.id} #${t}-${s} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').Te(`#actor-${this.m.id} #${a}-${i}`);e.to(l,{...o.Oe({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,At:"slow(0.7, 0.7)",Ie(){$(r).dt("full")},Me(){$(n).U("full"),$(l).remove()},we(){$(n).U("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,At:"slow(0.7, 0.7, true)"})}async K(t){const e=t.currentTarget.dataset.V;await this.m.update({Ee:e})}async Ne(e,s,a,i,r={}){e===a&&(a=!1);const n=[],l=[];for(const[r,l]of[[e,s],[a,i]])if(r){const e=['<span class="character">(</span>',`<span class="trait-value">${l}</span>`,'<span class="character">)</span>'];t.kt.includes(r)?(e.unshift(`<span class="trait-name strategy">${o.jt(r)}</span>`),n.unshift(e.join(""))):t.je.includes(r)?(e.unshift(`<span class="trait-name tactic">${o.jt(r)}</span>`),n.push(e.join(""))):(e.unshift(`<span class="trait-name">${o.jt(r)}</span>`),n.push(e.join("")))}let c=0,h=0;for(const[t,{Fe:e,width:s}]of Object.entries(r)){const a=`<span class="advantage-glyph">${{Ge:"‚öîÔ∏è",He:'<span style="color: #FF0000; font-weight: bold; text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black;">!!</span>',ze:"üîç"}[t]}</span>`;e&&(c+=e,n.push(`<span class="trait-value">${e}</span>${a}`)),s&&(h+=s,l.push(`<span class="trait-value">+${s}</span>${a}`))}const d=o.Be(s)+o.Be(i)+o.Be(c),p=[n.join('<span class="operator">+</span>'),'<span class="operator">=</span>',`<span class="pool-total">${d}</span>`].join(""),u=game.oneRollEngine.createRawRoll(d),{Le:$,Ke:m,qe:g}=game.oneRollEngine.parseRawRoll(u,p),b=$.sort(((t,e)=>t.width>e.width?-10:e.width>t.width?10:e.height-t.height));0===$.length&&(l.length=0),console.log({Le:$,Ke:m,Je:g,Qe:l,Ue:r});const f={content:await renderTemplate("systems/betterangels/hbs/chat/ORE-roll.html",{name:this.m.name,Le:b,Ke:m,Je:g,Qe:l.join(", ")}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,Ve:u,flags:{We:{Xe:!0}}};return ChatMessage.create(f,{})}}export const HOOKS={Ye:(t,s)=>{const{type:a}=s,{m:i}=t,{items:o}=i,r=Array.from(o.values()).filter((t=>t.type===s.type)).map((t=>t.id)),n={Ze:i.data.data.R?3:2,ts:2,device:3}[a],l=[];for(;r.length>=n;)l.push(r.shift());console.log({type:a,m:i,items:o,es:r,ss:n,os:l}),l.length&&(i.rs("Item",l),e.ns(.25,(()=>i.sheet.q())))}};export const EFFECTS=[{name:"fade",effect:(t,s)=>e.to(t,{Se:1,duration:s.duration,ct(){e.set(this.ls,{ht:"transform"})}}),cs:{duration:.25},hs:!0},{name:"brighten",effect:(s,a)=>e.to(s,{color:t.$t.ut.ds,scale:1.25,duration:a.duration,ct(){e.set(this.ls,{ht:"transform"})}}),cs:{duration:.25},hs:!0},{name:"darken",effect:(t,s)=>e.to(t,{opacity:.25,duration:s.duration,ct(){e.set(this.ls,{ht:"transform"})}}),cs:{duration:.25},hs:!0}];