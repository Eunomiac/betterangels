import{C as t,gsap as a,Dragger as e,MotionPathPlugin as s,U as o,MIX as i,UpdateQueue as r}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(r)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/hbs/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/hbs/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=(a=super.getData(),{...a,type:a.m.data.type,data:a.m.data.data,flags:a.m.data.flags});var a;return["hellbound","minornpc","mobnpc"].includes(t.type)&&(this.g(t),this.v(t)),t}v(a){Object.entries(t.S).forEach((([t,e])=>{const[s,o]=this.k(t);Object.assign(a.data[t],{name:s.name,D:s.max-s.value,T:s._,O:s.add,P:s.A}),Object.assign(a.data[e],{name:o.name,D:o.max-o.value,T:o._,O:o.add,P:o.A})}))}g(t){console.log({C:t,I:t.items}),Object.assign(t.data,{R:t.items.filter((t=>"power"===t.type)).slice(t.data.M?-3:-2),j:t.items.filter((t=>"aspect"===t.type)).slice(-2),N:t.items.filter((t=>"device"===t.type)).slice(-2)})}F(s){if(super.F(s),window.G=s,window.sheet=this,!this.K)return;const i=this;s.find(".radial-hover").contextmenu(this.L.bind(this)),s.find(".radial-hover").B(this.H.bind(this)),s.find(".trait-button").click(this.X.bind(this)),s.find(".trait-button").contextmenu(this.X.bind(this)),s.find(".trait-pair.strategy label.sinister .draggable").q(this.J.bind(this)),s.find(".trait-pair .virtuous").U(((t,a)=>{$(a).find(".trait.draggable").U(((t,e)=>o.set([e,$(e).prev()],{x:o.get(a,"width")-1.1*o.get(e,"width")})))})),s.find(".feature").V({pointerEvents:"all"}).click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.W(!0)})),e.create(`#actor-${this.m.id} .draggable.trait`,{Y(){this.Z=this.target.dataset.target,[this.type,this.tt]=t.et.includes(this.Z)?["strategy","tactic"]:["tactic","strategy"],console.log({st:this.Z,ot:this.type,it:this.tt,rt:t.et.includes(this.Z)}),this.nt=Array.from(s.find(`#trait-label-${this.Z} .display.trait, .draggable.trait.${this.tt}`)),[this.lt]=s.find(this.target).parent(),s.find(".trait-pair label.droppable").ct("no-hover"),o.ht(this.target,$("#x-container")[0]),this.update(!1,!0),console.log({dt:this}),a.to(this.target,{scale:2,fontFamily:"Komikax, sans-serif",color:t.G.ut[this.type],opacity:1,duration:2,textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",$t:"elastic.out"})},bt:{points(e){if(!this.nt||0===this.nt.length)return e;let s,o=50;for(;o<80&&(!s||s.length>1);){const t=(s??[...this.nt]).filter((t=>this.yt(t,`${o}%`)));if(0===t.length)break;s=[...t],o+=10}return s&&s.includes(this.ft)?e:(this.gt?.reverse(),s?([this.ft]=s,this.gt=a.to(this.ft,{vt(){a.set(this.ft,{zIndex:1e3})},scale:2,fontFamily:"Komikax, sans-serif",color:t.G.ut[$(this.ft).hasClass("display")?this.type:this.tt],opacity:1,$t:"back",textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",duration:.5}),e):(this.ft=null,e))}},xt(){console.log("DRAG END"),console.log(`SNAP TARGET: ${this.ft?.dataset?.target}`);const[e,r]=[this.target.dataset.target,this.target.dataset.value],[n,l]=[this.ft?.dataset?.target,this.ft?.dataset?.value];this.disable(),o.ht(this.target,this.lt),a.to(this.target,{scale:1,opacity:0,duration:.25,$t:"elastic.out",St:this,wt(){a.set(`#actor-${i.m.id} .draggable`,{x:0,y:0}),this.enable(),s.find("label.droppable").kt("no-hover"),i.Dt(e,r,n,l)}}),a.to(this.ft,{y:0,color:t.G.ut.Tt,textShadow:"none",fontSize:14,scale:1,$t:"power4.out",duration:.25})}})}k(a){const[e,s]=[a,t._t[a]],{min:o,max:i,value:r}=this.Ot.data[e],{min:n,max:l,value:c}=this.Ot.data[s];return[{name:e,min:o,max:i,value:r,add:r<i&&r+c<7,A:r>o,_:r<i&&c>n},{name:s,min:n,max:l,value:c,add:c<l&&r+c<7,A:c>n,_:c<l&&r>o}]}Pt(a){a=t.At[a]??a;const[e,s]=this.k(a);o.Ct({[`#menu-add-drop-${e.name}`]:{It:e.add,Rt:e.A},[`#menu-add-drop-${s.name}`]:{It:s.add,Rt:s.A},[`#menu-slide-${e.name}`]:{Mt:e._},[`#menu-slide-${s.name}`]:{Et:s._}},((t,a)=>o.Ct(t,((t,e)=>{t?$(`#${this.m.id} ${a}`).ct(e):$(`#${this.m.id} ${a}`).kt(e)}))))}L(t){t.preventDefault(),console.log("Open Menu",t);const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find(".radial-menu").hasClass("active")||(a.set(e,{jt:-50,Nt:-50,x:t.offsetX,y:t.offsetY}),$(e).find("video").U((function(){this.play()})),$(e).find(".radial-menu").ct("active"))}H(t){t.preventDefault();const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find("video").U((function(){this.pause()})),$(a).find(".radial-menu").kt("active"),setTimeout((()=>this.Ft()),500)}async X(a){a.preventDefault(),console.log({Gt:a});const{Kt:e,Lt:s,target:o}=a.target.dataset,{data:i}=this.Ot,r={click:e,contextmenu:s}[a.type];if(this.k(o)[0][r]){switch(r){case"add":{const t=Math.min(i[o].max,i[o].value+1);this.zt({[`data.${o}.value`]:t}),this.Bt(o,t);break}case"drop":this.Ht(o,i[o].value),this.zt({[`data.${o}.value`]:Math.max(i[o].min,i[o].value-1)});break;case"slide":{const a=t._t[o],e=Math.min(i[o].max,i[o].value+1);this.Xt(o,e,a,i[a].value),this.zt({[`data.${o}.value`]:e,[`data.${a}.value`]:Math.max(i[a].min,i[a].value-1)});break}default:return!1}return this.Pt(o),!0}return!1}Bt(t,e){const[s]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`);a.timeline({vt(){$(s).ct("full top-layer")},Jt(){$(s).ct("full"),$(s).kt("top-layer"),a.set(s,{Qt:"all"})},wt(){$(s).ct("full"),$(s).kt("top-layer"),a.set(s,{Qt:"all"})}}).qt(s,{scale:10,opacity:0},{scale:1,opacity:1,$t:"sine",duration:.75,Qt:!0})}Ht(t,e){const[s]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`);a.timeline({vt(){$(s).ct("top-layer")},Jt(){$(s).kt("full top-layer"),a.set(s,{Qt:"all"})},wt(){$(s).kt("full top-layer"),a.set(s,{Qt:"all"})}}).qt(s,{scale:1,opacity:1},{scale:10,opacity:0,$t:"sine",duration:.75,Qt:!0})}Xt(t,e,s,i){const[r]=$(`#actor-${this.m.id} #${s}-${i} > .dot-slot`),[n]=$(`#actor-${this.m.id} #${t}-${e} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`#actor-${this.m.id} #${s}-${i}`);a.to(l,{...o.Ut({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,$t:"slow(0.7, 0.7)",vt(){$(r).kt("full")},Jt(){$(n).ct("full"),$(l).remove()},wt(){$(n).ct("full"),$(l).remove()}}),a.to(l,{scale:5,duration:.5,$t:"slow(0.7, 0.7, true)"})}async J(t){const a=t.currentTarget.dataset.target;await this.m.update({Vt:a})}async Dt(a,e,s,i,r={}){a===s&&(s=!1);const n=[],l=[];for(const[r,l]of[[a,e],[s,i]])if(r){const a=['<span class="character">(</span>',`<span class="trait-value">${l}</span>`,'<span class="character">)</span>'];t.et.includes(r)?(a.unshift(`<span class="trait-name strategy">${o.Wt(r)}</span>`),n.unshift(a.join(""))):t.Yt.includes(r)?(a.unshift(`<span class="trait-name tactic">${o.Wt(r)}</span>`),n.push(a.join(""))):(a.unshift(`<span class="trait-name">${o.Wt(r)}</span>`),n.push(a.join("")))}let c=0,p=0;for(const[t,{Zt:a,width:e}]of Object.entries(r)){const s=`<span class="advantage-glyph">${{ta:"‚öîÔ∏è",aa:'<span style="color: #FF0000; font-weight: bold; text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black;">!!</span>',ea:"üîç"}[t]}</span>`;a&&(c+=a,n.push(`<span class="trait-value">${a}</span>${s}`)),e&&(p+=e,l.push(`<span class="trait-value">+${e}</span>${s}`))}const h=o.sa(e)+o.sa(i)+o.sa(c),d=[n.join('<span class="operator">+</span>'),'<span class="operator">=</span>',`<span class="pool-total">${h}</span>`].join(""),u=game.oneRollEngine.createRawRoll(h),{oa:$,ia:m,ra:b}=game.oneRollEngine.parseRawRoll(u,d),y=$.sort(((t,a)=>t.width>a.width?-10:a.width>t.width?10:a.height-t.height));0===$.length&&(l.length=0),console.log({oa:$,ia:m,na:b,la:l,ca:r});const f={content:await renderTemplate("systems/betterangels/hbs/chat/ORE-roll.html",{name:this.m.name,oa:y,ia:m,na:b,la:l.join(", ")}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,pa:u,flags:{ha:{da:!0}}};return ChatMessage.create(f,{})}}export const HOOKS={ua:(t,e)=>{const{type:s}=e,{m:o}=t,{items:i}=o,r=Array.from(i.values()).filter((t=>t.type===e.type)).map((t=>t.id)),n={$a:o.data.data.M?3:2,ma:2,device:3}[s],l=[];for(;r.length>=n;)l.push(r.shift());console.log({type:s,m:o,items:i,ba:r,ya:n,fa:l}),l.length&&(o.ga("Item",l),a.va(.25,(()=>o.sheet.W())))}};