import{C as t,gsap as e,Dragger as a,MotionPathPlugin as s,U as o,MIX as i,UpdateQueue as n}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(n)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/hbs/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/hbs/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=(e=super.getData(),{...e,type:e.m.data.type,data:e.m.data.data,flags:e.m.data.flags});var e;return["hellbound","minornpc","mobnpc"].includes(t.type)&&(this.v(t),this.g(t)),t}k(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{S:-50,_:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}A(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.D()),500)}P(t){t.preventDefault(),console.log({C:t.currentTarget});const[a]=$(t.currentTarget).find("video");a.status="fade-in",e.T(a,{opacity:0},{opacity:1,duration:.5,I:"sine"}),a.play()}M(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,I:"sine"})}async O(e,a,s,i,n=0,r=0){if(e===s)return!1;const l=[];for(const[n,r]of[[e,a],[s,i]])if(n){const e=[`<span class="trait-name ${t.R.includes(n)?"strategy":"tactic"}">${o.N(n)}</span>`,'<span class="character">(</span>',`<span class="trait-value">${r}</span>`,'<span class="character">)</span>'].join("");t.R.includes(n)?l.unshift(e):l.push(e)}n&&l.push(`<span class="advantage-value">${n}</span>`);const c=o.j(a)+o.j(i)+o.j(n),p=[l.join('<span class="operator">+</span>'),'<span class="operator">=</span>',`<span class="pool-total">${c}</span>`].join(""),d=game.oneRollEngine.createRawRoll(c),{G:h,H:u,L:$}=game.oneRollEngine.parseRawRoll(d,p),m=h.sort(((t,e)=>t.width>e.width?-10:e.width>t.width?10:e.height-t.height)),b={content:await renderTemplate("systems/betterangels/hbs/chat/ORE-roll.html",{name:this.m.name,G:m,H:u,B:$,F:[].join("")}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,K:d,flags:{V:{U:!0}}};return ChatMessage.create(b,{})}Y(t,a){const[s]=$(`.app.betterangels #${t}-${a} > .dot-slot`);e.timeline({q(){$(s).addClass("full top-layer")},J(){$(s).addClass("full"),$(s).removeClass("top-layer"),e.set(s,{W:"all"})},X(){$(s).addClass("full"),$(s).removeClass("top-layer"),e.set(s,{W:"all"})}}).T(s,{scale:10,opacity:0},{scale:1,opacity:1,I:"sine",duration:.75,W:!0})}Z(t,a){const[s]=$(`#${t}-${a} > .dot-slot`);e.timeline({q(){$(s).addClass("top-layer")},J(){$(s).removeClass("full top-layer"),e.set(s,{W:"all"})},X(){$(s).removeClass("full top-layer"),e.set(s,{W:"all"})}}).T(s,{scale:1,opacity:1},{scale:10,opacity:0,I:"sine",duration:.75,W:!0})}tt(t,a,s,i){const[n]=$(`.app.betterangels #${s}-${i} > .dot-slot`),[r]=$(`.app.betterangels #${t}-${a} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`.app.betterangels #${s}-${i}`);e.to(l,{...o.et({x:0,y:0},$(r).parent()[0],$(n).parent()[0]),duration:.5,I:"slow(0.7, 0.7)",q(){$(n).removeClass("full")},J(){$(r).addClass("full"),$(l).remove()},X(){$(r).addClass("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,I:"slow(0.7, 0.7, true)"})}g(e){Object.entries(t.st).forEach((([t,a])=>{const[s,o]=this.ot(t);Object.assign(e.data[t],{name:s.name,it:s.max-s.value,nt:s.rt,lt:s.add,ct:s.dt}),Object.assign(e.data[a],{name:o.name,it:o.max-o.value,nt:o.rt,lt:o.add,ct:o.dt})}))}v(t){Object.assign(t.data,{ht:t.items.filter((t=>"power"===t.type)),ut:t.items.filter((t=>"aspect"===t.type)),$t:t.items.filter((t=>"device"===t.type))})}bt(s){if(super.bt(s),!this.ft)return;const i=this;s.find(".radial-hover").contextmenu(this.k.bind(this)),s.find(".radial-hover").yt(this.A.bind(this)),s.find(".trait-button").click(this.vt.bind(this)),s.find(".trait-button").contextmenu(this.vt.bind(this)),$(".trait-pair .virtuous").each(((t,e)=>{$(e).find(".trait.draggable").each(((t,a)=>o.set([a,$(a).prev()],{x:o.get(e,"width")-1.1*o.get(a,"width")})))})),$(".feature").css({pointerEvents:"all"}).click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.gt(!0)})),Hooks.on("preCreateItem",((t,e)=>{const{type:a}=e;switch(e.type){case"power":{const t=Array.from(this.m.items.values()).filter((t=>"power"===t.data.type));3===t.length&&t[0].delete();break}case"aspect":{const t=Array.from(this.m.items.values()).filter((t=>"aspect"===t.data.type));2===t.length&&t[0].delete();break}}}));const n=e=>{e=o.xt(e);const a=t.R.includes(e)?"strategy":"tactic",s=new Map;$(`#trait-label-${e}`).removeClass("faded-trait");const[i]=$(`#trait-label-${e} .display`),n=o.kt(i);return s.set(n,i),t.R.forEach((t=>{if(t!==e)if("tactic"===a){$(`#trait-label-${t}`).removeClass("faded-trait");const[e]=$(`#trait-label-${t} .display`),a=o.kt(e);a.x+=15,a.y+=15,s.set(a,e)}else $(`#trait-label-${t}`).addClass("faded-trait")})),t.St.forEach((t=>{if(t!==e)if("strategy"===a){$(`#trait-label-${t}`).removeClass("faded-trait");const[e]=$(`#trait-label-${t} .display`),a=o.kt(e);a.x-=15,a.y-=15,s.set(a,e)}else $(`#trait-label-${t}`).addClass("faded-trait")})),t["strategy"===a?"St":"R"].forEach((t=>{})),s};a.create(".draggable.trait",{wt(){this._t=[];const a=this.target.dataset.target;this.At=n(a),[this.Dt]=$(this.target).parent(),$("label.droppable").addClass("no-hover"),o.Pt(this.target,$("#x-container")[0]),this.update(!1,!0),e.to(this.target,{scale:2,fontFamily:"Komikax, sans-serif",color:t.Mt.It[t.R.includes(a)?"Ct":"Tt"],opacity:1,duration:2,textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",I:"elastic.out"})},Ot:{points(a){const s=this.target.dataset.target;this.At||(this.At=n(s));const o=e.Et.Rt({values:Array.from(this.At.keys()),Nt:25},a),i=this.At.get(o),r=this.jt;if(i?.id!==r?.id&&(r&&(console.log(`UNSNAPPING ${r.dataset.target}`),e.set($(r).parent(),{pointerEvents:"none"}),$(r).parent().data("snapAnim").reverse().then((()=>e.set($(r).parent(),{pointerEvents:"all"}))),delete this.Gt,delete this.jt),i)){const[a]=$(i).parent();e.set(a,{pointerEvents:"none"});const n=a.id===this.Dt.id?{x:"+=0",y:"+=0"}:{x:"tactic"===i.dataset.type?"+=25":"-=25",y:"tactic"===i.dataset.type?"+=15":"-=15"};$(i).parent().data({Ht:e.T(i,{zIndex:1e3},{...n,scale:2,fontFamily:"Komikax, sans-serif",color:t.Mt.It[t.R.includes(s)?"Tt":"Ct"],opacity:1,I:"back",textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",duration:.5})}),this.Gt=o,this.jt=i,console.log(`SNAPPING TO ${this.jt.dataset.target}`)}return this.Gt??a}},Lt(){console.log("DRAG END"),console.log(`SNAP TARGET: ${this.jt?.dataset?.target}`);const[a,s]=[this.target.dataset.target,this.target.dataset.value],[n,r]=[this.jt?.dataset?.target,this.jt?.dataset?.value];this.disable(),o.Pt(this.target,this.Dt),e.to(this.target,{scale:1,opacity:0,duration:1,I:"elastic.out",zt:this,X(){e.set(this.target,{x:0,y:0}),this.enable(),$("label.droppable").removeClass("no-hover"),i.O(a,s,n,r)}}),e.to(this.jt,{y:0,color:t.Mt.It.Bt,textShadow:"none",fontSize:14,scale:1,I:"power4.out",duration:.5})}})}ot(e){const[a,s]=[e,t.Ft[e]],{min:o,max:i,value:n}=this.Kt.data[a],{min:r,max:l,value:c}=this.Kt.data[s];return[{name:a,min:o,max:i,value:n,add:n<i&&n+c<7,dt:n>o,rt:n<i&&c>r},{name:s,min:r,max:l,value:c,add:c<l&&n+c<7,dt:c>r,rt:c<l&&n>o}]}Vt(t,e){return this.ot(t)[0][e]}Ut(e){e=t.Yt[e]??e;const[a,s]=this.ot(e);o.qt({[`#menu-add-drop-${a.name}`]:{Jt:a.add,Qt:a.dt},[`#menu-add-drop-${s.name}`]:{Jt:s.add,Qt:s.dt},[`#menu-slide-${a.name}`]:{Wt:a.rt},[`#menu-slide-${s.name}`]:{Xt:s.rt}},((t,e)=>o.qt(t,((t,a)=>{t?$(e).addClass(a):$(e).removeClass(a)}))))}async vt(e){e.preventDefault(),console.log({Zt:e});const{te:a,ee:s,target:o}=e.target.dataset,{data:i}=this.Kt,n={click:a,contextmenu:s}[e.type];if(this.Vt(o,n)){switch(n){case"add":{const t=Math.min(i[o].max,i[o].value+1);this.ae({[`data.${o}.value`]:t}),this.Y(o,t);break}case"drop":this.Z(o,i[o].value),this.ae({[`data.${o}.value`]:Math.max(i[o].min,i[o].value-1)});break;case"slide":{const e=t.Ft[o],a=Math.min(i[o].max,i[o].value+1);this.tt(o,a,e,i[e].value),this.ae({[`data.${o}.value`]:a,[`data.${e}.value`]:Math.max(i[e].min,i[e].value-1)});break}default:return!1}return this.Ut(o),!0}return!1}async se(t){console.log("On Item Create Called")}oe(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.ie&&"item"===a.ie){const{itemId:t}=e.closest(".item").dataset,a=this.m.items.get(t);if(a)return a.K()}if(a.K){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.K,this.m.ne()).K();return e.re({le:ChatMessage.getSpeaker({m:this.m}),ce:t,pe:game.settings.get("core","rollMode")}),e}return!1}}