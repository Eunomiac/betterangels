import{C as t,gsap as e,Dragger as a,MotionPathPlugin as o,U as s,MIX as i,UpdateQueue as r}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(r)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=(e=super.getData(),{...e,type:e.m.data.type,data:e.m.data.data,flags:e.m.data.flags});var e;return["hellbound","minornpc","mobnpc"].includes(t.type)&&(this.g(t),this.v(t)),t}k(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{S:-50,_:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}C(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.D()),500)}M(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-in",e.I(a,{opacity:0},{opacity:1,duration:.5,P:"sine"}),a.play()}A(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,P:"sine"})}O(a,o){const{target:i,value:r}=a.dataset,[{dataset:{target:n,value:l}}]=$(o)?.find(".draggable")??[{dataset:{}}],[c]=$(o).find(".display");$(c).addClass("big-gold click-through"),e.to(a,{scale:5,y:"-=75px",opacity:0,duration:1,P:"power.out",T:function(){$(this).removeClass("click-through"),e.set(this,{opacity:0,x:0,y:0,scale:1})}.bind(a)}),e.to(c,{scale:5,y:"+=75px",opacity:0,duration:1,P:"power.out",T(){$(c).removeClass("big-gold"),e.set(c,{scale:1,y:"-=75px"}),e.I(c,{opacity:0},{opacity:1,duration:.25,P:"sine",T(){$(c).removeClass("click-through"),e.set(c,{y:0}),e.set(a,{opacity:0})}})}});const p=[];t.R.includes(i)?(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.j(i)}</span> ${r} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.j(n)}</span> ${l}</h1>`)):(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.j(n)}</span> ${l} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.j(i)}</span> ${r}</h1>`)),p.push(`<h3>(${s.H(r)+s.H(l)} Dice Total)`),$("#sheet-message").html(p.join(""));const[d]=$("#sheet-message").find("h1"),[h]=$("#sheet-message").find("h3");e.I(d,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,P:"power4.out"}),e.I(h,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,P:"power4.in",T(){e.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,N:.2,P:"power4.out"})}})}B(t,a){const[o]=$(`.app.betterangels #${t}-${a} > .dot-slot`);e.timeline({V(){$(o).addClass("full top-layer")},G(){$(o).addClass("full"),$(o).removeClass("top-layer"),e.set(o,{L:"all"})},T(){$(o).addClass("full"),$(o).removeClass("top-layer"),e.set(o,{L:"all"})}}).I(o,{scale:10,opacity:0},{scale:1,opacity:1,P:"sine",duration:.75,L:!0})}q(t,a){const[o]=$(`#${t}-${a} > .dot-slot`);e.timeline({V(){$(o).addClass("top-layer")},G(){$(o).removeClass("full top-layer"),e.set(o,{L:"all"})},T(){$(o).removeClass("full top-layer"),e.set(o,{L:"all"})}}).I(o,{scale:1,opacity:1},{scale:10,opacity:0,P:"sine",duration:.75,L:!0})}F(t,a,o,i){const[r]=$(`.app.betterangels #${o}-${i} > .dot-slot`),[n]=$(`.app.betterangels #${t}-${a} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`.app.betterangels #${o}-${i}`);e.to(l,{...s.J({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,P:"slow(0.7, 0.7)",V(){$(r).removeClass("full")},G(){$(n).addClass("full"),$(l).remove()},T(){$(n).addClass("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,P:"slow(0.7, 0.7, true)"})}v(e){Object.entries(t.K).forEach((([t,a])=>{const[o,s]=this.U(t);Object.assign(e.data[t],{name:o.name,W:o.max-o.value,X:o.Y,Z:o.add,tt:o.et}),Object.assign(e.data[a],{name:s.name,W:s.max-s.value,X:s.Y,Z:s.add,tt:s.et})}))}g(t){Object.assign(t.data,{ot:t.items.filter((t=>"power"===t.type)),st:t.items.filter((t=>"aspect"===t.type)),it:t.items.filter((t=>"device"===t.type))})}rt(o){if(super.rt(o),o.find(".feature").click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.nt(!0)})),!this.lt)return;o.find(".radial-hover").contextmenu(this.k.bind(this)),o.find(".radial-hover").ct(this.C.bind(this)),o.find(".trait-pair > label").dt(this.M.bind(this),this.A.bind(this)),o.find(".trait-button").click(this.ht.bind(this)),o.find(".trait-button").contextmenu(this.ht.bind(this)),$(".trait-pair .virtuous").each(((t,a)=>{const o=e.ut(a,"width");$(a).find(".trait").each(((t,a)=>{const s=e.ut(a,"width");e.set(a,{x:o-1.1*s})}))})),Hooks.on("preCreateItem",((t,e)=>{const{type:a}=e;switch(e.type){case"power":{const t=Array.from(this.m.items.values()).filter((t=>"power"===t.data.type));3===t.length&&t[0].delete();break}case"aspect":{const t=Array.from(this.m.items.values()).filter((t=>"aspect"===t.data.type));2===t.length&&t[0].delete();break}}}));a.create(".draggable.trait",{$t(){[this.yt]=$(this.target).parent(),s.gt(this.target,$("#x-container")[0]),this.update(!1,!0),e.to(this.target,{scale:2,opacity:1,duration:2,P:"elastic.out"})},ft:{points(a){if(!this.bt){const[,,e]=this.target.id.split("-");this.bt=(e=>{e=s.vt(e);const a=new Map,[o]=$(`#trait-label-${e} .display`),i=s.wt(o);return a.set(i,o),t[t.R.includes(e)?"xt":"R"].forEach((t=>{const[e]=$(`#trait-label-${t} .display`),o=s.wt(e);o.y+=15,a.set(o,e)})),console.log(`***SNAP POINTS for ${s.kt(e)} ***`),console.log(a),console.log("==================="),a})(e)}const o=e._t.St({values:Array.from(this.bt.keys()),Ct:25},a),i=this.bt.get(o);let r=!1;return i&&i.id!==this.Dt?.id?(r=this.Dt,this.Dt=i,e.to(i,{y:-25,color:"rgb(255, 215, 0)",textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",fontSize:10,scale:3,P:"power4.out",duration:.5})):!i&&this.Dt&&(r=this.Dt,delete this.Dt),r&&e.to(r,{y:0,color:"rgb(179, 179, 179)",textShadow:"none",fontSize:14,scale:1,P:"power4.out",duration:.5}),i?o:a}},Mt(){$(this.target).addClass("click-through"),s.gt(this.target,this.yt);e.to(this.target,{scale:1,opacity:0,duration:1,P:"elastic.out",T(){}}),e.to(this.Dt,{y:0,color:"rgb(179, 179, 179)",textShadow:"none",fontSize:14,scale:1,P:"power4.out",duration:.5}),delete this.Dt,delete this.bt}})}U(e){const[a,o]=[e,t.It[e]],{min:s,max:i,value:r}=this.Pt.data[a],{min:n,max:l,value:c}=this.Pt.data[o];return[{name:a,min:s,max:i,value:r,add:r<i&&r+c<7,et:r>s,Y:r<i&&c>n},{name:o,min:n,max:l,value:c,add:c<l&&r+c<7,et:c>n,Y:c<l&&r>s}]}At(t,e){return this.U(t)[0][e]}Ot(e){e=t.Tt[e]??e;const[a,o]=this.U(e);s.Rt({[`#menu-add-drop-${a.name}`]:{jt:a.add,Ht:a.et},[`#menu-add-drop-${o.name}`]:{jt:o.add,Ht:o.et},[`#menu-slide-${a.name}`]:{zt:a.Y},[`#menu-slide-${o.name}`]:{Nt:o.Y}},((t,e)=>s.Rt(t,((t,a)=>{t?$(e).addClass(a):$(e).removeClass(a)}))))}async ht(e){e.preventDefault(),console.log({Bt:e});const{Et:a,Vt:o,target:s}=e.target.dataset,{data:i}=this.Pt,r={click:a,contextmenu:o}[e.type];if(this.At(s,r)){switch(r){case"add":{const t=Math.min(i[s].max,i[s].value+1);this.Gt({[`data.${s}.value`]:t}),this.B(s,t);break}case"drop":this.q(s,i[s].value),this.Gt({[`data.${s}.value`]:Math.max(i[s].min,i[s].value-1)});break;case"slide":{const e=t.It[s],a=Math.min(i[s].max,i[s].value+1);this.F(s,a,e,i[e].value),this.Gt({[`data.${s}.value`]:a,[`data.${e}.value`]:Math.max(i[e].min,i[e].value-1)});break}default:return!1}return this.Ot(s),!0}return!1}async Lt(t){console.log("On Item Create Called")}qt(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.Ft&&"item"===a.Ft){const{itemId:t}=e.closest(".item").dataset,a=this.m.items.get(t);if(a)return a.Jt()}if(a.Jt){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.Jt,this.m.Kt()).Jt();return e.Qt({Ut:ChatMessage.getSpeaker({m:this.m}),Wt:t,Xt:game.settings.get("core","rollMode")}),e}return!1}}