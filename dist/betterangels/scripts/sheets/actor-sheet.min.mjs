export default class extends ActorSheet{static get t(){return mergeObject(super.t,{i:["betterangels","sheet","actor"],h:"systems/betterangels/templates/actor/actor-sheet.html",width:700,height:700,o:[{l:".sheet-tabs",m:".sheet-body",u:"stats"}]})}get h(){return`systems/betterangels/templates/actor/actor-${this.p.data.type}-sheet.html`}getData(){const t=super.getData(),e=t.p.data;return t.data=e.data,t.flags=e.flags,"character"===e.type&&(this.g(t),this.I(t)),t.$=t.p.v(),t}I(t){}g(t){const e=[],a=[];for(const s of t.items)s.M=s.M||DEFAULT_TOKEN,"item"===s.type?e.push(s):"feature"===s.type&&a.push(s);t.C=e,t.features=a}O(t){if(super.O(t),t.find(".item-edit").click((t=>{const e=$(t.currentTarget).parents(".item");this.p.items.get(e.data("itemId")).sheet._(!0)})),this.N&&(t.find(".trait-button").click(this.F.bind(this)),t.find(".item-create").click(this.D.bind(this)),t.find(".item-delete").click((t=>{const e=$(t.currentTarget).parents(".item");this.p.items.get(e.data("itemId")).delete(),e.G(200,(()=>this._(!1)))})),t.find(".rollable").click(this.S.bind(this)),this.p.T)){const e=t=>this.A(t);t.find("li.item").L(((t,a)=>{a.classList.contains("inventory-header")||(a.setAttribute("draggable",!0),a.addEventListener("dragstart",e,!1))}))}}async F(t){const{action:e,target:a}=t.target.dataset,{data:s}=this.p.data;switch(e){case"add":return this.p.update({[`data.${a}.value`]:Math.min(s[a].max,s[a].value+1)});case"drop":return this.p.update({[`data.${a}.value`]:Math.max(s[a].min,s[a].value-1)});case"slide":return this.p.update({[`data.${a}.value`]:Math.min(s[a].max,s[a].value+1),[`data.${CONFIG.BETTERANGELS.traitPairs[a]}.value`]:Math.max(s[CONFIG.BETTERANGELS.traitPairs[a]].min,s[CONFIG.BETTERANGELS.traitPairs[a]].value-1)});default:return!1}}async D(t){t.preventDefault();const e=t.currentTarget,{type:a}=e.dataset,s=duplicate(e.dataset),r={name:`New ${a.R()}`,type:a,data:s};return delete r.data.type,await Item.create(r,{parent:this.p})}S(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.j&&"item"===a.j){const{itemId:t}=e.closest(".item").dataset,a=this.p.items.get(t);if(a)return a.k()}if(a.k){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.k,this.p.v()).k();return e.K({U:ChatMessage.getSpeaker({p:this.p}),q:t,B:game.settings.get("core","rollMode")}),e}return!1}}