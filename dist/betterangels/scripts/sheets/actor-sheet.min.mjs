import{C as t,gsap as e,Dragger as a,MotionPathPlugin as o,U as s,MIX as i,UpdateQueue as n}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(n)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",m:"front"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.$.data.type}-sheet.html`}getData(){const t=super.getData(),e=s.g(t.$.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.v(t),this.F(t)),t.k=t.$.C(),t}D(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{_:-50,T:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}M(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.O()),500)}R(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-in",e.j(a,{opacity:.1},{opacity:1,duration:.5,S:"sine"}),a.play()}A(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,S:"sine"})}I(a,o){const{target:i,value:n}=a.dataset,[{dataset:{target:r,value:l}}]=$(o)?.find(".draggable")??[{dataset:{}}],[c]=$(o).find(".display");$(c).addClass("big-gold click-through"),e.to(a,{scale:5,y:"-=75px",opacity:0,duration:1,S:"power.out",L:function(){$(this).removeClass("click-through"),e.set(this,{opacity:0,x:0,y:0,scale:1})}.bind(a)}),e.to(c,{scale:5,y:"+=75px",opacity:0,duration:1,S:"power.out",L(){$(c).removeClass("big-gold"),e.set(c,{scale:1,y:"-=75px"}),e.j(c,{opacity:0},{opacity:1,duration:.25,S:"sine",L(){$(c).removeClass("click-through"),e.set(c,{y:0}),e.set(a,{opacity:0})}})}});const p=[];t.B.includes(i)?(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.N(i)}</span> ${n} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.N(r)}</span> ${l}</h1>`)):(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.N(r)}</span> ${l} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.N(i)}</span> ${n}</h1>`)),p.push(`<h3>(${s.P(n)+s.P(l)} Dice Total)`),$("#sheet-message").html(p.join(""));const[h]=$("#sheet-message").find("h1"),[d]=$("#sheet-message").find("h3");e.j(h,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,S:"power4.out"}),e.j(d,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,S:"power4.in",L(){e.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,V:.2,S:"power4.out"})}})}G(t,a){const[o]=$(`#${t}-${a} > .dot-animation`);e.timeline({L(){$(o).removeClass("empty")}}).j(o,{scale:7,backgroundColor:"#FFFFFF",opacity:0},{scale:1,opacity:1,backgroundColor:"#FFFFFF",S:"sine",duration:.5})}H(t,a){const[o]=$(`#${t}-${a} > .dot-animation`);e.timeline({L(){$(o).addClass("empty")}}).j(o,{scale:1,backgroundColor:"#FFFFFF",opacity:1},{scale:10,opacity:0,backgroundColor:"#FFFFFF",S:"sine",duration:.75})}q(t,e,a,o){console.log({J:t,K:e,U:a,W:o}),this.H(a,o),setTimeout((()=>this.G(t,e)),250)}F(e){Object.entries(t.X).forEach((([t,a])=>{const[o,s]=this.Y(t);Object.assign(e.data[t],{name:o.name,Z:o.max-o.value,tt:o.et,ot:o.add,st:o.it}),Object.assign(e.data[a],{name:s.name,Z:s.max-s.value,tt:s.et,ot:s.add,st:s.it})}))}v(t){Object.assign(t.data,{nt:t.items.filter((t=>"power"===t.type)),rt:t.items.filter((t=>"aspect"===t.type)),lt:t.items.filter((t=>"device"===t.type))})}ct(t){if(super.ct(t),!this.ht)return;const o=this;t.find(".radial-hover").contextmenu(this.D.bind(this)),t.find(".radial-hover").dt(this.M.bind(this)),t.find(".trait-pair > label").ut(this.R.bind(this),this.A.bind(this)),t.find(".trait-button").click(this.$t.bind(this)),t.find(".trait-button").contextmenu(this.$t.bind(this)),a.create(".trait-pair .draggable",{yt(){this.gt=Array.from($(".droppable")).filter((t=>!new RegExp(`${this.target.dataset.target}$`).test(t.id))),e.to(this.target,{scale:2,opacity:1,duration:2,S:"elastic.out"})},bt(){this.gt.forEach((t=>{if(this.ft(t,"50%"))e.to($(t).find(".display").addClass("highlight"),{y:-10,scale:3,S:"power4.out",duration:.5}),this.vt=t;else if(this.vt?.id!==t.id){const[a]=$(t).find(".display");$(a).removeClass("highlight"),e.to(a,{y:0,scale:1,S:"power4.out",duration:.5})}}))},Ft(){const t=this;$(".droppable .display.highlight").each(((a,s)=>{$(s).removeClass("highlight"),e.to(s,{y:0,scale:1,S:"power4.out",duration:.5,L(){o.I(t.target,t.vt)}})})),$(this.target).addClass("click-through")}})}Y(e){const[a,o]=[e,t.wt[e]],{min:s,max:i,value:n}=this.kt.data[a],{min:r,max:l,value:c}=this.kt.data[o];return[{name:a,min:s,max:i,value:n,add:n<i&&n+c<7,it:n>s,et:n<i&&c>r},{name:o,min:r,max:l,value:c,add:c<l&&n+c<7,it:c>r,et:c<l&&n>s}]}xt(t,e){return this.Y(t)[0][e]}Ct(e){e=t.Dt[e]??e;const[a,o]=this.Y(e);Object.entries({[`#menu-add-${a.name}`]:a.add,[`#menu-add-${o.name}`]:o.add,[`#menu-drop-${a.name}`]:a.it,[`#menu-drop-${o.name}`]:o.it,[`#menu-slide-${a.name}`]:a.et,[`#menu-slide-${o.name}`]:o.et,[`#menu-add-drop-${a.name}`]:a.add||a.it,[`#menu-add-drop-${o.name}`]:o.add||o.it,[`#menu-slash-${a.name}`]:a.add&&a.it,[`#menu-slash-${o.name}`]:o.add&&o.it}).forEach((([t,e])=>{e?$(t).removeClass("off"):$(t).addClass("off")}))}async $t(e){e.preventDefault(),console.log({_t:e});const{Tt:a,Mt:o,target:s}=e.target.dataset,{data:i}=this.kt,n={click:a,contextmenu:o}[e.type];if(this.xt(s,n)){switch(n){case"add":{const t=Math.min(i[s].max,i[s].value+1);this.Ot({[`data.${s}.value`]:t}),this.G(s,t);break}case"drop":this.H(s,i[s].value),this.Ot({[`data.${s}.value`]:Math.max(i[s].min,i[s].value-1)});break;case"slide":{const e=t.wt[s],a=Math.min(i[s].max,i[s].value+1);this.q(s,a,e,i[e].value),this.Ot({[`data.${s}.value`]:a,[`data.${e}.value`]:Math.max(i[e].min,i[e].value-1)});break}default:return!1}return this.Ct(s),!0}return!1}async Rt(t){t.preventDefault();const e=t.currentTarget,{type:a}=e.dataset,o=duplicate(e.dataset),s={name:`New ${a.jt()}`,type:a,data:o};return delete s.data.type,await Item.create(s,{parent:this.$})}St(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.At&&"item"===a.At){const{itemId:t}=e.closest(".item").dataset,a=this.$.items.get(t);if(a)return a.It()}if(a.It){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.It,this.$.C()).It();return e.Et({Lt:ChatMessage.getSpeaker({$:this.$}),Bt:t,Nt:game.settings.get("core","rollMode")}),e}return!1}}