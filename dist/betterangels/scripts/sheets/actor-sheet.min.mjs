import{gsap as t,Dragger as e,InertiaPlugin as a,MotionPathPlugin as o,GSDevTools as s,RoughEase as i,U as n,MIX as r,UpdateQueue as l}from"../helpers/bundler.mjs";export default class extends(r(ActorSheet).t(l)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:700,height:700,p:[{h:".sheet-tabs",u:".sheet-body",m:"stats"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.$.data.type}-sheet.html`}getData(){const t=super.getData(),e=n.g(t.$.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.v(t),this.C(t)),t.k=t.$.D(),t}C(t){Object.entries(CONFIG.BETTERANGELS.sinisterTraitPairs).forEach((([e,a])=>{const{min:o,max:s,value:i}=t.data[e],{min:n,max:r,value:l}=t.data[a];Object.assign(t.data[e],{name:e,O:s-i,_:i<s&&l>n&&i+l<7,T:i<s&&i+l<7,I:i>o}),Object.assign(t.data[a],{name:a,O:r-l,_:l<r&&i>o&&i+l<7,T:l<r&&i+l<7,I:l>n})}))}M(e){const[a]=$(e.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")?this.N(e):(t.set(a,{R:-50,A:-50,x:e.offsetX,y:e.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}N(t){const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.j()),500)}F(t){const[e]=$(t.currentTarget).find("video")}G(e){const[a]=$(e.currentTarget).find("video");a.play(),setTimeout((()=>a.play()),150),t.S(a,{opacity:0},{opacity:1,duration:.5,L:"sine",V(){a.play()}})}P(e){const[a]=$(e.currentTarget).find("video");t.to(a,{opacity:0,duration:.5,L:"sine",V(){a.pause()}})}B(e,a){const{target:o,value:s}=e.dataset,[{dataset:{target:i,value:r}}]=$(a)?.find(".draggable")??[{dataset:{}}],[l]=$(a).find(".display");$(l).addClass("big-gold click-through"),t.to(e,{scale:5,y:"-=75px",opacity:0,duration:1,L:"power.out",V(){$(e).removeClass("click-through"),t.set(e,{opacity:0,x:0,y:0,scale:1})}}),t.to(l,{scale:5,y:"+=75px",opacity:0,duration:1,L:"power.out",V(){$(l).removeClass("big-gold"),t.set(l,{scale:1,y:"-=75px"}),t.S(l,{opacity:0},{opacity:1,duration:.25,L:"sine",V(){$(l).removeClass("click-through"),t.set(l,{y:0}),t.set(e,{opacity:0})}})}});const c=[];CONFIG.BETTERANGELS.strategies.includes(o)?(c.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${n.H(o)}</span> ${s} + `),c.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${n.H(i)}</span> ${r}</h1>`)):(c.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${n.H(i)}</span> ${r} + `),c.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${n.H(o)}</span> ${s}</h1>`)),c.push(`<h3>(${n.K(s)+n.K(r)} Dice Total)`),$("#sheet-message").html(c.join(""));const[p]=$("#sheet-message").find("h1"),[h]=$("#sheet-message").find("h3");t.S(p,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,L:"power4.out"}),t.S(h,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,L:"power4.in",V(){t.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,U:.2,L:"power4.out"})}})}q(e,a){const[o]=$(`#${e}-${a} > .dot-animation`),[s]=$(o).closest(".radial-hover").find(".radial-menu"),[i]=$(s).find("video");t.J(i,"scale");t.timeline({V(){$(o).removeClass("empty")}}).S(o,{scale:7,backgroundColor:"rgb(0, 0, 0)",opacity:0},{scale:1,opacity:1,backgroundColor:"rgb(0, 0, 0)",L:"sine",duration:.5})}W(e,a){const[o]=$(`#${e}-${a} > .dot-animation`),[s]=$(o).closest(".radial-hover").find(".radial-menu"),[i]=$(s).find("video");t.J(i,"scale");t.timeline({V(){$(o).addClass("empty")}}).S(o,{scale:1,backgroundColor:"rgb(0, 0, 0)",opacity:1},{scale:10,opacity:0,backgroundColor:"rgb(0, 0, 0)",L:"sine",duration:.75})}X(t,e,a,o){this.W(a,o),setTimeout((()=>this.q(t,e)),250)}v(t){const e=[],a=[];for(const o of t.items)o.Y=o.Y||DEFAULT_TOKEN,"item"===o.type?e.push(o):"feature"===o.type&&a.push(o);t.Z=e,t.features=a}tt(a){if(super.tt(a),!this.et)return;const o=this;a.find(".radial-hover").contextmenu(this.M.bind(this)),a.find(".radial-hover").ot(this.N.bind(this)),a.find(".trait-pair > label").st(this.G.bind(this),this.P.bind(this)),a.find(".trait-button").click(this.it.bind(this)),e.create(".trait-pair .draggable",{nt(){this.rt=Array.from($(".droppable")).filter((t=>!new RegExp(`${this.target.dataset.target}$`).test(t.id))),t.to(this.target,{scale:2,opacity:1,duration:2,L:"elastic"})},lt(){this.rt.forEach((e=>{if(this.ct(e,"50%")){const[a]=$(e).find(".display");$(a).addClass("highlight"),t.to(a,{y:-10,scale:3,L:"power4.out",duration:.5}),this.ht=e}else if(this.ht?.id!==e.id){const[a]=$(e).find(".display");$(a).removeClass("highlight"),t.to(a,{y:0,scale:1,L:"power4.out",duration:.5})}}))},dt(){$(".droppable .display.highlight").each(((e,a)=>{$(a).removeClass("highlight"),t.to(a,{y:0,scale:1,L:"power4.out",duration:.5})})),$(this.target).addClass("click-through"),o.B(this.target,this.ht)}})}ut(t){t=CONFIG.BETTERANGELS.virtuousTraitPairs[t]??t;const[e,a]=[t,CONFIG.BETTERANGELS.traitPairs[t]],{min:o,max:s,value:i}=this.$t.data[e],{min:n,max:r,value:l}=this.$t.data[a];Object.entries({[`#menu-add-${e}`]:i<s&&i+l<7,[`#menu-add-${a}`]:l<r&&i+l<7,[`#menu-drop-${e}`]:i>o,[`#menu-drop-${a}`]:l>n,[`#menu-slide-${e}`]:i<s&&l>n&&i+l<7,[`#menu-slide-${a}`]:l<r&&i>o&&i+l<7}).forEach((([t,e])=>{e?$(t).removeClass("empty"):$(t).addClass("empty")}))}async it(t){console.log({yt:t});const{action:e,target:a}=t.target.dataset,{data:o}=this.$t;switch(e){case"add":{const t=Math.min(o[a].max,o[a].value+1);this.gt({[`data.${a}.value`]:t}),this.q(a,t);break}case"drop":this.W(a,o[a].value),this.gt({[`data.${a}.value`]:Math.max(o[a].min,o[a].value-1)});break;case"slide":{const t=CONFIG.BETTERANGELS.traitPairs[a],e=Math.min(o[a].max,o[a].value+1);this.X(a,e,t,o[t].value),this.gt({[`data.${a}.value`]:e,[`data.${t}.value`]:Math.max(o[t].min,o[t].value-1)});break}default:return!1}return this.ut(a),!0}async bt(t){t.preventDefault();const e=t.currentTarget,{type:a}=e.dataset,o=duplicate(e.dataset),s={name:`New ${a.vt()}`,type:a,data:o};return delete s.data.type,await Item.create(s,{parent:this.$})}ft(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.Ct&&"item"===a.Ct){const{itemId:t}=e.closest(".item").dataset,a=this.$.items.get(t);if(a)return a.wt()}if(a.wt){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.wt,this.$.D()).wt();return e.kt({xt:ChatMessage.getSpeaker({$:this.$}),Dt:t,Ot:game.settings.get("core","rollMode")}),e}return!1}}