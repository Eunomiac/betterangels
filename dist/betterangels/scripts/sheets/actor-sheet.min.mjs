import{gsap as t,Dragger as e,InertiaPlugin as a,MotionPathPlugin as s,GSDevTools as r,RoughEase as i,U as o}from"../helpers/bundler.mjs";export default class extends ActorSheet{static get t(){return mergeObject(super.t,{i:["betterangels","sheet","actor"],o:"systems/betterangels/templates/actor/actor-sheet.html",width:700,height:700,l:[{h:".sheet-tabs",u:".sheet-body",m:"stats"}]})}get o(){return`systems/betterangels/templates/actor/actor-${this.p.data.type}-sheet.html`}get $(){return this.g=this.g??{}}get v(){return o.D(this.p.data,o.expand(this.$))}getData(){const t=super.getData(),e=o.C(t.p.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.O(t),this.I(t)),t.M=t.p.k(),t}get animate(){return{T:(e,a)=>{const s=`#${e}-${a}`;t.to(s,{backgroundColor:"rgba(0, 0, 0, 1)",_:"power.out",duration:1,A(){$(s).removeClass("empty")}})},N:(e,a)=>{const s=`#${e}-${a}`;t.to(s,{backgroundColor:"rgba(0, 0, 0, 0)",_:"power.out",duration:1,A(){$(s).addClass("empty")}})},j:(t,e,a,s)=>{this.animate.T(t,e),this.animate.N(a,s)}}}async R(t={}){return t={...this.$,...t},delete this.g,this.p.update(t)}I(t){Object.entries(CONFIG.BETTERANGELS.sinisterTraitPairs).forEach((([e,a])=>{const{min:s,max:r,value:i}=t.data[e],{min:o,max:n,value:c}=t.data[a];Object.assign(t.data[e],{name:e,S:r-i,F:i<r&&c>o&&i+c<7,G:i<r&&i+c<7,L:i>s}),Object.assign(t.data[a],{name:a,S:n-c,F:c<n&&i>s&&i+c<7,G:c<n&&i+c<7,L:c>o})}))}U(t){console.log(t),$(t.currentTarget).find(".radial-menu")?.addClass("active")}B(t){$(".radial-menu.active").removeClass("active"),setTimeout((()=>this.p.update(this.$)),500)}O(t){const e=[],a=[];for(const s of t.items)s.H=s.H||DEFAULT_TOKEN,"item"===s.type?e.push(s):"feature"===s.type&&a.push(s);t.K=e,t.features=a}q(a){if(super.q(a),!this.J)return;const s=this;a.find(".radial-hover").contextmenu(this.U.bind(this)),a.find(".radial-hover").P(this.B.bind(this)),a.find(".trait-button").click(this.V.bind(this)),a.find(".radial-menu video").W((function(){this.play()})),e.create(".trait-pair > label > span",{X(){t.to(this.target,{scale:2,opacity:1,duration:2,_:"elastic"})},Y(){$(this.target).addClass("click-through"),t.to(this.target,{scale:5,opacity:0,duration:1,_:"power.out",A(){$(this.target).removeClass("click-through"),s.Z(!0)}})}})}tt(t){t=CONFIG.BETTERANGELS.virtuousTraitPairs[t]??t;const[e,a]=[t,CONFIG.BETTERANGELS.traitPairs[t]],{min:s,max:r,value:i}=this.v.data[e],{min:o,max:n,value:c}=this.v.data[a];Object.entries({[`#menu-add-${e}`]:i<r&&i+c<7,[`#menu-add-${a}`]:c<n&&i+c<7,[`#menu-drop-${e}`]:i>s,[`#menu-drop-${a}`]:c>o,[`#menu-slide-${e}`]:i<r&&c>o&&i+c<7,[`#menu-slide-${a}`]:c<n&&i>s&&i+c<7}).forEach((([t,e])=>{e?$(t).removeClass("empty"):$(t).addClass("empty")}))}async V(t){console.log({et:t});const{action:e,target:a}=t.target.dataset,{data:s}=this.v;switch(e){case"add":{const t=Math.min(s[a].max,s[a].value+1);this.$[`data.${a}.value`]=t,this.animate.T(a,t);break}case"drop":this.animate.N(a,s[a].value),this.$[`data.${a}.value`]=Math.max(s[a].min,s[a].value-1);break;case"slide":{const t=CONFIG.BETTERANGELS.traitPairs[a],e=Math.min(s[a].max,s[a].value+1);this.animate.j(a,e,t,s[t].value),this.$[`data.${a}.value`]=e,this.$[`data.${t}.value`]=Math.max(s[t].min,s[t].value-1);break}default:return!1}return this.tt(a),!0}async st(t){t.preventDefault();const e=t.currentTarget,{type:a}=e.dataset,s=duplicate(e.dataset),r={name:`New ${a.rt()}`,type:a,data:s};return delete r.data.type,await Item.create(r,{parent:this.p})}it(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.ot&&"item"===a.ot){const{itemId:t}=e.closest(".item").dataset,a=this.p.items.get(t);if(a)return a.nt()}if(a.nt){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.nt,this.p.k()).nt();return e.ct({lt:ChatMessage.getSpeaker({p:this.p}),ht:t,dt:game.settings.get("core","rollMode")}),e}return!1}}