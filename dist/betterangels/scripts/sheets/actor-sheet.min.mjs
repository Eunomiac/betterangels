import{C as t,gsap as e,Dragger as a,MotionPathPlugin as o,U as s,MIX as i,UpdateQueue as n}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(n)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:700,height:700,p:[{h:".sheet-tabs",u:".sheet-body",m:"front"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.g.data.type}-sheet.html`}getData(){const t=super.getData(),e=s.$(t.g.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.v(t),this.C(t)),t.k=t.g.D(),t}_(t){t.preventDefault();const[a]=$(t.currentTarget).find(".menu-positioner");e.set(a,{M:-50,R:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active")}T(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.j()),500)}O(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-in",e.A(a,{opacity:.1},{opacity:1,duration:.5,S:"sine"}),a.play()}I(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,S:"sine"})}L(a,o){const{target:i,value:n}=a.dataset,[{dataset:{target:r,value:l}}]=$(o)?.find(".draggable")??[{dataset:{}}],[c]=$(o).find(".display");$(c).addClass("big-gold click-through"),e.to(a,{scale:5,y:"-=75px",opacity:0,duration:1,S:"power.out",N:function(){$(this).removeClass("click-through"),e.set(this,{opacity:0,x:0,y:0,scale:1})}.bind(a)}),e.to(c,{scale:5,y:"+=75px",opacity:0,duration:1,S:"power.out",N(){$(c).removeClass("big-gold"),e.set(c,{scale:1,y:"-=75px"}),e.A(c,{opacity:0},{opacity:1,duration:.25,S:"sine",N(){$(c).removeClass("click-through"),e.set(c,{y:0}),e.set(a,{opacity:0})}})}});const p=[];t.P.includes(i)?(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.V(i)}</span> ${n} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.V(r)}</span> ${l}</h1>`)):(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.V(r)}</span> ${l} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.V(i)}</span> ${n}</h1>`)),p.push(`<h3>(${s.B(n)+s.B(l)} Dice Total)`),$("#sheet-message").html(p.join(""));const[h]=$("#sheet-message").find("h1"),[d]=$("#sheet-message").find("h3");e.A(h,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,S:"power4.out"}),e.A(d,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,S:"power4.in",N(){e.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,G:.2,S:"power4.out"})}})}H(t,a){const[o]=$(`#${t}-${a} > .dot-animation`);e.timeline({N(){$(o).removeClass("empty")}}).A(o,{scale:7,backgroundColor:"rgb(0, 0, 0)",opacity:0},{scale:1,opacity:1,backgroundColor:"rgb(0, 0, 0)",S:"sine",duration:.5})}q(t,a){const[o]=$(`#${t}-${a} > .dot-animation`);e.timeline({N(){$(o).addClass("empty")}}).A(o,{scale:1,backgroundColor:"rgb(0, 0, 0)",opacity:1},{scale:10,opacity:0,backgroundColor:"rgb(0, 0, 0)",S:"sine",duration:.75})}F(t,e,a,o){this.q(a,o),setTimeout((()=>this.H(t,e)),250)}C(e){Object.entries(t.J).forEach((([t,a])=>{const{min:o,max:s,value:i}=e.data[t],{min:n,max:r,value:l}=e.data[a];Object.assign(e.data[t],{name:t,K:s-i,U:i<s&&l>n&&i+l<7,W:i<s&&i+l<7,X:i>o}),Object.assign(e.data[a],{name:a,K:r-l,U:l<r&&i>o&&i+l<7,W:l<r&&i+l<7,X:l>n})}))}v(t){Object.assign(t.data,{Y:t.items.filter((t=>"power"===t.type)),Z:t.items.filter((t=>"aspect"===t.type)),tt:t.items.filter((t=>"device"===t.type))})}et(t){if(super.et(t),!this.ot)return;const o=this;t.find(".radial-hover").contextmenu(this._.bind(this)),t.find(".radial-hover").st(this.T.bind(this)),t.find(".trait-pair > label").it(this.O.bind(this),this.I.bind(this)),t.find(".trait-button").click(this.nt.bind(this)),a.create(".trait-pair .draggable",{rt(){this.lt=Array.from($(".droppable")).filter((t=>!new RegExp(`${this.target.dataset.target}$`).test(t.id))),e.to(this.target,{scale:2,opacity:1,duration:2,S:"elastic.out"})},ct(){this.lt.forEach((t=>{if(this.ht(t,"50%"))e.to($(t).find(".display").addClass("highlight"),{y:-10,scale:3,S:"power4.out",duration:.5}),this.dt=t;else if(this.dt?.id!==t.id){const[a]=$(t).find(".display");$(a).removeClass("highlight"),e.to(a,{y:0,scale:1,S:"power4.out",duration:.5})}}))},ut(){const t=this;$(".droppable .display.highlight").each(((a,s)=>{$(s).removeClass("highlight"),e.to(s,{y:0,scale:1,S:"power4.out",duration:.5,N(){o.L(t.target,t.dt)}})})),$(this.target).addClass("click-through")}})}yt(e){e=t.gt[e]??e;const[a,o]=[e,t.$t[e]],{min:s,max:i,value:n}=this.bt.data[a],{min:r,max:l,value:c}=this.bt.data[o];Object.entries({[`#menu-add-${a}`]:n<i&&n+c<7,[`#menu-add-${o}`]:c<l&&n+c<7,[`#menu-drop-${a}`]:n>s,[`#menu-drop-${o}`]:c>r,[`#menu-slide-${a}`]:n<i&&c>r&&n+c<7,[`#menu-slide-${o}`]:c<l&&n>s&&n+c<7}).forEach((([t,e])=>{e?$(t).removeClass("empty"):$(t).addClass("empty")}))}async nt(e){e.preventDefault(),console.log({ft:e});const{action:a,target:o}=e.target.dataset,{data:s}=this.bt;switch(a){case"add":{const t=Math.min(s[o].max,s[o].value+1);this.vt({[`data.${o}.value`]:t}),this.H(o,t);break}case"drop":this.q(o,s[o].value),this.vt({[`data.${o}.value`]:Math.max(s[o].min,s[o].value-1)});break;case"slide":{const e=t.$t[o],a=Math.min(s[o].max,s[o].value+1);this.F(o,a,e,s[e].value),this.vt({[`data.${o}.value`]:a,[`data.${e}.value`]:Math.max(s[e].min,s[e].value-1)});break}default:return!1}return this.yt(o),!0}async wt(t){t.preventDefault();const e=t.currentTarget,{type:a}=e.dataset,o=duplicate(e.dataset),s={name:`New ${a.Ct()}`,type:a,data:o};return delete s.data.type,await Item.create(s,{parent:this.g})}kt(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.xt&&"item"===a.xt){const{itemId:t}=e.closest(".item").dataset,a=this.g.items.get(t);if(a)return a.Dt()}if(a.Dt){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.Dt,this.g.D()).Dt();return e._t({Mt:ChatMessage.getSpeaker({g:this.g}),Rt:t,Tt:game.settings.get("core","rollMode")}),e}return!1}}