import{C as t,gsap as e,Dragger as a,MotionPathPlugin as o,U as s,MIX as i,UpdateQueue as r}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(r)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=super.getData(),e=s.g(t.m.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.v(t),this._(t)),t.k=t.m.C(),t}D(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{M:-50,S:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}I(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.A()),500)}O(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-in",e.P(a,{opacity:.1},{opacity:1,duration:.5,R:"sine"}),a.play()}T(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,R:"sine"})}j(a,o){const{target:i,value:r}=a.dataset,[{dataset:{target:n,value:l}}]=$(o)?.find(".draggable")??[{dataset:{}}],[c]=$(o).find(".display");$(c).addClass("big-gold click-through"),e.to(a,{scale:5,y:"-=75px",opacity:0,duration:1,R:"power.out",L:function(){$(this).removeClass("click-through"),e.set(this,{opacity:0,x:0,y:0,scale:1})}.bind(a)}),e.to(c,{scale:5,y:"+=75px",opacity:0,duration:1,R:"power.out",L(){$(c).removeClass("big-gold"),e.set(c,{scale:1,y:"-=75px"}),e.P(c,{opacity:0},{opacity:1,duration:.25,R:"sine",L(){$(c).removeClass("click-through"),e.set(c,{y:0}),e.set(a,{opacity:0})}})}});const p=[];t.B.includes(i)?(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.H(i)}</span> ${r} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.H(n)}</span> ${l}</h1>`)):(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.H(n)}</span> ${l} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.H(i)}</span> ${r}</h1>`)),p.push(`<h3>(${s.V(r)+s.V(l)} Dice Total)`),$("#sheet-message").html(p.join(""));const[h]=$("#sheet-message").find("h1"),[d]=$("#sheet-message").find("h3");e.P(h,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,R:"power4.out"}),e.P(d,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,R:"power4.in",L(){e.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,G:.2,R:"power4.out"})}})}N(t,a){const[o]=$(`.app.betterangels #${t}-${a} > .dot-slot`);e.timeline({q(){$(o).addClass("full top-layer")},F(){$(o).addClass("full"),$(o).removeClass("top-layer"),e.set(o,{J:"all"})},L(){$(o).addClass("full"),$(o).removeClass("top-layer"),e.set(o,{J:"all"})}}).P(o,{scale:10,opacity:0},{scale:1,opacity:1,R:"sine",duration:.75,J:!0})}K(t,a){const[o]=$(`#${t}-${a} > .dot-slot`);e.timeline({q(){$(o).addClass("top-layer")},F(){$(o).removeClass("full top-layer"),e.set(o,{J:"all"})},L(){$(o).removeClass("full top-layer"),e.set(o,{J:"all"})}}).P(o,{scale:1,opacity:1},{scale:10,opacity:0,R:"sine",duration:.75,J:!0})}U(t,a,o,i){const[r]=$(`.app.betterangels #${o}-${i} > .dot-slot`),[n]=$(`.app.betterangels #${t}-${a} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`.app.betterangels #${o}-${i}`);e.to(l,{...s.W({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,R:"slow(0.7, 0.7)",q(){$(r).removeClass("full")},F(){$(n).addClass("full"),$(l).remove()},L(){$(n).addClass("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,R:"slow(0.7, 0.7, true)"})}_(e){Object.entries(t.X).forEach((([t,a])=>{const[o,s]=this.Y(t);Object.assign(e.data[t],{name:o.name,Z:o.max-o.value,tt:o.et,ot:o.add,st:o.it}),Object.assign(e.data[a],{name:s.name,Z:s.max-s.value,tt:s.et,ot:s.add,st:s.it})}))}v(t){Object.assign(t.data,{rt:t.items.filter((t=>"power"===t.type)),nt:t.items.filter((t=>"aspect"===t.type)),lt:t.items.filter((t=>"device"===t.type))})}ct(t){if(super.ct(t),t.find(".feature").click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.ht(!0)})),!this.dt)return;const o=this;t.find(".radial-hover").contextmenu(this.D.bind(this)),t.find(".radial-hover").ut(this.I.bind(this)),t.find(".trait-pair > label").$t(this.O.bind(this),this.T.bind(this)),t.find(".trait-button").click(this.yt.bind(this)),t.find(".trait-button").contextmenu(this.yt.bind(this)),Hooks.on("preCreateItem",((t,e)=>{const{type:a}=e;switch(e.type){case"power":{const t=Array.from(this.m.items.values()).filter((t=>"power"===t.data.type));3===t.length&&t[0].delete();break}case"aspect":{const t=Array.from(this.m.items.values()).filter((t=>"aspect"===t.data.type));2===t.length&&t[0].delete();break}}})),a.create(".draggable.trait",{gt(){this.ft=Array.from($(".droppable")).filter((t=>!new RegExp(`${this.target.dataset.target}$`).test(t.id))),[this.bt]=$(this.target).parent(),s.vt(this.target,$("#x-container")[0]),this.update(!1,!0),e.to(this.target,{scale:2,opacity:1,duration:2,R:"elastic.out"})},wt(){this.ft.forEach((t=>{if(this.xt(t,"50%"))e.to($(t).find(".display").addClass("highlight"),{y:-10,scale:3,R:"power4.out",duration:.5}),this._t=t;else if(this._t?.id!==t.id){const[a]=$(t).find(".display");$(a).removeClass("highlight"),e.to(a,{y:0,scale:1,R:"power4.out",duration:.5})}}))},kt(){const t=this;$(".droppable .display.highlight").each(((a,i)=>{$(i).removeClass("highlight"),s.vt(this.target,this.bt),e.to(i,{y:0,scale:1,R:"power4.out",duration:.5,L(){o.j(t.target,t._t)}})})),$(this.target).addClass("click-through")}})}Y(e){const[a,o]=[e,t.Ct[e]],{min:s,max:i,value:r}=this.Dt.data[a],{min:n,max:l,value:c}=this.Dt.data[o];return[{name:a,min:s,max:i,value:r,add:r<i&&r+c<7,it:r>s,et:r<i&&c>n},{name:o,min:n,max:l,value:c,add:c<l&&r+c<7,it:c>n,et:c<l&&r>s}]}Mt(t,e){return this.Y(t)[0][e]}St(e){e=t.It[e]??e;const[a,o]=this.Y(e);s.At({[`#menu-add-drop-${a.name}`]:{Ot:a.add,Pt:a.it},[`#menu-add-drop-${o.name}`]:{Ot:o.add,Pt:o.it},[`#menu-slide-${a.name}`]:{Rt:a.et},[`#menu-slide-${o.name}`]:{Tt:o.et}},((t,e)=>s.At(t,((t,a)=>{t?$(e).addClass(a):$(e).removeClass(a)}))))}async yt(e){e.preventDefault(),console.log({jt:e});const{Et:a,Lt:o,target:s}=e.target.dataset,{data:i}=this.Dt,r={click:a,contextmenu:o}[e.type];if(this.Mt(s,r)){switch(r){case"add":{const t=Math.min(i[s].max,i[s].value+1);this.Bt({[`data.${s}.value`]:t}),this.N(s,t);break}case"drop":this.K(s,i[s].value),this.Bt({[`data.${s}.value`]:Math.max(i[s].min,i[s].value-1)});break;case"slide":{const e=t.Ct[s],a=Math.min(i[s].max,i[s].value+1);this.U(s,a,e,i[e].value),this.Bt({[`data.${s}.value`]:a,[`data.${e}.value`]:Math.max(i[e].min,i[e].value-1)});break}default:return!1}return this.St(s),!0}return!1}async Ht(t){console.log("On Item Create Called")}Vt(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.Gt&&"item"===a.Gt){const{itemId:t}=e.closest(".item").dataset,a=this.m.items.get(t);if(a)return a.Nt()}if(a.Nt){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.Nt,this.m.C()).Nt();return e.qt({zt:ChatMessage.getSpeaker({m:this.m}),Ft:t,Jt:game.settings.get("core","rollMode")}),e}return!1}}