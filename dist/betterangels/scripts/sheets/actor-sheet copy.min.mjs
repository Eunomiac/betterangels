import{C as t,gsap as e,Dragger as a,MotionPathPlugin as o,U as s,MIX as i,UpdateQueue as r}from"../helpers/bundler.mjs";export default class extends(i(ActorSheet).t(r)){static get o(){return mergeObject(super.o,{i:["betterangels","sheet","actor"],l:"systems/betterangels/templates/actor/actor-sheet.html",width:476,height:786,p:[{h:".sheet-tabs",u:".sheet-body",$:"front"}]})}get l(){return`systems/betterangels/templates/actor/actor-${this.m.data.type}-sheet.html`}getData(){const t=super.getData(),e=s.g(t.m.data);return t.data=e.data,t.flags=e.flags,["hellbound","minornpc","mobnpc"].includes(e.type)&&(this.v(t),this.k(t)),t}C(t){t.preventDefault(),console.log("Open Menu",t);const[a]=$(t.currentTarget).find(".menu-positioner");$(a).find(".radial-menu").hasClass("active")||(e.set(a,{S:-50,_:-50,x:t.offsetX,y:t.offsetY}),$(a).find("video").each((function(){this.play()})),$(a).find(".radial-menu").addClass("active"))}D(t){t.preventDefault();const[e]=$(t.currentTarget).find(".menu-positioner");$(e).find("video").each((function(){this.pause()})),$(e).find(".radial-menu").removeClass("active"),setTimeout((()=>this.M()),500)}A(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");e.O(a,{opacity:0},{opacity:1,duration:.5,T:"sine",I(){this.R=a.play()}})}j(t){t.preventDefault();const[a]=$(t.currentTarget).find("video");a.status="fade-out",e.to(a,{opacity:0,duration:.5,T:"sine"})}P(a,o){const{target:i,value:r}=a.dataset,[{dataset:{target:n,value:l}}]=$(o)?.find(".draggable")??[{dataset:{}}],[c]=$(o).find(".display");$(c).addClass("big-gold click-through"),e.to(a,{scale:5,y:"-=75px",opacity:0,duration:1,T:"power.out",H:function(){$(this).removeClass("click-through"),e.set(this,{opacity:0,x:0,y:0,scale:1})}.bind(a)}),e.to(c,{scale:5,y:"+=75px",opacity:0,duration:1,T:"power.out",H(){$(c).removeClass("big-gold"),e.set(c,{scale:1,y:"-=75px"}),e.O(c,{opacity:0},{opacity:1,duration:.25,T:"sine",H(){$(c).removeClass("click-through"),e.set(c,{y:0}),e.set(a,{opacity:0})}})}});const p=[];t.N.includes(i)?(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.B(i)}</span> ${r} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.B(n)}</span> ${l}</h1>`)):(p.push(`<h1><span style="color: darkgreen !important; font-weight: bold !important; font-style: normal !important;">${s.B(n)}</span> ${l} + `),p.push(`<span style="color: purple !important; font-weight: normal !important; font-style: italic !important;">${s.B(i)}</span> ${r}</h1>`)),p.push(`<h3>(${s.L(r)+s.L(l)} Dice Total)`),$("#sheet-message").V(p.join(""));const[d]=$("#sheet-message").find("h1"),[h]=$("#sheet-message").find("h3");e.O(d,{scale:10,opacity:0},{scale:1,opacity:1,duration:.5,T:"power4.out"}),e.O(h,{scale:1,y:"+=300px",opacity:0},{y:0,opacity:1,duration:1,T:"power4.in",H(){e.to("#sheet-message *",{opacity:0,scale:5,duration:.5,delay:1,G:.2,T:"power4.out"})}})}q(a,o,s=!0){let[i]=$(`#dot-${a}-${o}`);i||([i]=$(`<span id="dot-${a}-${o}" class="dot">&nbsp;</span>`).appendTo(`.app.betterangels #${a}-${o}`),e.set(i,{border:`1px solid ${t.V.J.F}`,borderRadius:"50%",background:t.V.W.U.K,opacity:s?0:1,scale:s?10:1,position:"absolute",height:"100%",width:"100%"})),s&&e.O(i,{borderColor:t.V.J.X,background:t.V.W.U.X},{scale:1,opacity:1,background:t.V.W.U.K,borderColor:t.V.J.F,T:"sine",duration:.75})}Y(a,o){const[s]=$(`#dot-${a}-${o}`);s&&e.O(s,{borderColor:t.V.J.Z,background:t.V.W.U.Z},{scale:10,opacity:0,background:t.V.W.U.empty,borderColor:t.V.J.F,T:"sine",duration:.75,H(){e.set(s,{opacity:1,scale:1})}})}tt(t,a,o,i){const[r]=$(`.app.betterangels #${o}-${i} > .dot-slot`),[n]=$(`.app.betterangels #${t}-${a} > .dot-slot`),[l]=$('<span class="dot-slot full top-layer">&nbsp;</span>').appendTo(`.app.betterangels #${o}-${i}`);e.to(l,{...s.et({x:0,y:0},$(n).parent()[0],$(r).parent()[0]),duration:.5,T:"slow(0.7, 0.7)",I(){$(r).removeClass("full")},ot(){$(n).addClass("full"),$(l).remove()},H(){$(n).addClass("full"),$(l).remove()}}),e.to(l,{scale:5,duration:.5,T:"slow(0.7, 0.7, true)"})}k(e){Object.entries(t.st).forEach((([t,a])=>{const[o,s]=this.it(t);Object.assign(e.data[t],{name:o.name,rt:o.max-o.value,nt:o.lt,ct:o.add,dt:o.ht}),Object.assign(e.data[a],{name:s.name,rt:s.max-s.value,nt:s.lt,ct:s.add,dt:s.ht})}))}v(t){Object.assign(t.data,{ut:t.items.filter((t=>"power"===t.type)),$t:t.items.filter((t=>"aspect"===t.type)),yt:t.items.filter((t=>"device"===t.type))})}bt(o){if(super.bt(o),o.find(".feature").click((t=>{this.m.items.get(t.currentTarget.dataset.itemId).sheet.gt(!0)})),!this.ft)return;const i=this;o.find(".radial-hover").contextmenu(this.C.bind(this)),o.find(".radial-hover").vt(this.D.bind(this)),o.find(".trait-pair > label").wt(this.A.bind(this),this.xt.bind(this)),o.find(".trait-button").click(this.kt.bind(this)),o.find(".trait-button").contextmenu(this.kt.bind(this)),$(".trait-pair .virtuous").each(((t,a)=>{const o=e.Ct(a,"width");$(a).find(".trait").each(((t,a)=>{const s=e.Ct(a,"width");e.set(a,{x:o-1.1*s})}))})),Hooks.on("preCreateItem",((t,e)=>{const{type:a}=e;switch(e.type){case"power":{const t=Array.from(this.m.items.values()).filter((t=>"power"===t.data.type));3===t.length&&t[0].delete();break}case"aspect":{const t=Array.from(this.m.items.values()).filter((t=>"aspect"===t.data.type));2===t.length&&t[0].delete();break}}}));a.create(".draggable.trait",{St(){[this._t]=$(this.target).parent(),s.Dt(this.target,$("#x-container")[0]),this.update(!1,!0),e.to(this.target,{scale:2,opacity:1,duration:2,T:"elastic.out"})},Mt:{points(a){if(!this.At){const[,,e]=this.target.id.split("-");this.At=(e=>{e=s.Ot(e);const a=new Map,[o]=$(`#trait-label-${e} .display`),i=s.Tt(o);return a.set(i,o),t[t.N.includes(e)?"It":"N"].forEach((t=>{const[e]=$(`#trait-label-${t} .display`),o=s.Tt(e);o.y+=15,a.set(o,e)})),console.log(`***SNAP POINTS for ${s.Rt(e)} ***`),console.log(a),console.log("==================="),a})(e)}const o=e.Pt.jt({values:Array.from(this.At.keys()),zt:1e4},a),i=this.At.get(o);return i.id!==this.Ht?.id&&(e.to(i,{y:-25,color:"rgb(255, 215, 0)",textShadow:"0 0 3px black, 0 0 3px black, 0 0 3px black, 0 0 3px black",fontSize:10,scale:3,T:"power4.out",duration:.5}),this.Ht&&e.to(this.Ht,{y:0,color:"rgb(179, 179, 179)",textShadow:"none",fontSize:14,scale:1,T:"power4.out",duration:.5})),this.Ht=i,o}},Nt(){$(this.target).addClass("click-through"),s.Dt(this.target,this._t);const t=this;e.to(this.target,{scale:1,opacity:0,duration:1,T:"elastic.out",H(){i.P(t.target,t.Ht)}}),e.to(this.Ht,{y:0,color:"rgb(179, 179, 179)",textShadow:"none",fontSize:14,scale:1,T:"power4.out",duration:.5}),delete this.Ht}})}it(e){const[a,o]=[e,t.Bt[e]],{min:s,max:i,value:r}=this.Et.data[a],{min:n,max:l,value:c}=this.Et.data[o];return[{name:a,min:s,max:i,value:r,add:r<i&&r+c<7,ht:r>s,lt:r<i&&c>n},{name:o,min:n,max:l,value:c,add:c<l&&r+c<7,ht:c>n,lt:c<l&&r>s}]}Lt(t,e){return this.it(t)[0][e]}Vt(e){e=t.Gt[e]??e;const[a,o]=this.it(e);s.qt({[`#menu-add-drop-${a.name}`]:{Ft:a.add,Jt:a.ht},[`#menu-add-drop-${o.name}`]:{Ft:o.add,Jt:o.ht},[`#menu-slide-${a.name}`]:{Kt:a.lt},[`#menu-slide-${o.name}`]:{Qt:o.lt}},((t,e)=>s.qt(t,((t,a)=>{t?$(e).addClass(a):$(e).removeClass(a)}))))}async kt(e){e.preventDefault(),console.log({Ut:e});const{Wt:a,Xt:o,target:s}=e.target.dataset,{data:i}=this.Et,r={click:a,contextmenu:o}[e.type];if(this.Lt(s,r)){switch(r){case"add":{const t=Math.min(i[s].max,i[s].value+1);this.Yt({[`data.${s}.value`]:t}),this.q(s,t);break}case"drop":this.Y(s,i[s].value),this.Yt({[`data.${s}.value`]:Math.max(i[s].min,i[s].value-1)});break;case"slide":{const e=t.Bt[s],a=Math.min(i[s].max,i[s].value+1);this.tt(s,a,e,i[e].value),this.Yt({[`data.${s}.value`]:a,[`data.${e}.value`]:Math.max(i[e].min,i[e].value-1)});break}default:return!1}return this.Vt(s),!0}return!1}async Zt(t){console.log("On Item Create Called")}te(t){t.preventDefault();const e=t.currentTarget,{dataset:a}=e;if(a.ee&&"item"===a.ee){const{itemId:t}=e.closest(".item").dataset,a=this.m.items.get(t);if(a)return a.ae()}if(a.ae){const t=a.label?`[roll] ${a.label}`:"",e=new Roll(a.ae,this.m.oe()).ae();return e.se({ie:ChatMessage.getSpeaker({m:this.m}),re:t,ne:game.settings.get("core","rollMode")}),e}return!1}}